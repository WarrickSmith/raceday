# Story 4.3: Display Money Flow column

**Status**: Ready for Review

**As a** user  
**I want** to see a dedicated column displaying the current "Money Flow" (hold_percentage) for each entrant  
**So that** I can track market interest.

## Acceptance Criteria

1. Money Flow column is present for every entrant. [Source: docs/prd/epic-4-detailed-race-view.md#L53]
2. Values match backend data. [Source: docs/prd/epic-4-detailed-race-view.md#L54]
3. Column is visually distinct. [Source: docs/prd/epic-4-detailed-race-view.md#L55]

## Dev Notes

### Previous Story Insights

Key relevant outputs from Story 4.2 (create entrants data grid) that must be preserved and extended:

- EntrantsGrid component already established in `client/src/components/race-view/EntrantsGrid.tsx` [Source: docs/stories/4.2.create-entrants-data-grid.md#L223]
- Server-side data fetching pattern using `createServerClient()` successfully implemented [Source: docs/stories/4.2.create-entrants-data-grid.md#L22-L23]
- Real-time subscription architecture with `useRealtimeEntrants` custom hook established [Source: docs/stories/4.2.create-entrants-data-grid.md#L190]
- Performance optimization patterns (React.memo, useMemo) proven and implemented [Source: docs/stories/4.2.create-entrants-data-grid.md#L197-L199]
- TypeScript interfaces for Entrant data model defined in `client/src/types/meetings.ts` [Source: docs/stories/4.2.create-entrants-data-grid.md#L180]
- Accessibility patterns (ARIA labelling, semantic HTML) established [Source: docs/stories/4.2.create-entrants-data-grid.md#L202-L207]
- Component testing patterns with React Testing Library in place [Source: docs/stories/4.2.create-entrants-data-grid.md#L217-L219]

### Data Models

**Money Flow Data Schema:**
- Money Flow data (hold_percentage) available via MoneyFlowHistory collection in Appwrite Database [Source: docs/architecture/2-appwrite-database-schema.md#L47-L56]
- MoneyFlowHistory collection linked to Entrant via relationship attribute [Source: docs/architecture/2-appwrite-database-schema.md#L52-L53]
- Current hold_percentage values accessible for real-time display in the Money Flow column [Source: docs/prd/epic-4-detailed-race-view.md#L42]
- Real-time money flow updates accessible via MoneyFlowHistory collection subscription [Source: docs/architecture/4-frontend-real-time-communication.md#L173-L175]
- TypeScript interfaces may need extension in `client/src/types/meetings.ts` to include money flow percentage fields

### Next.js 15 Performance Requirements

**Server Component Strategy:**
- Server Component in `/race/[id]/page.tsx` should extend existing entrants data fetching to include money flow data via `createServerClient()` [Source: docs/architecture/4-frontend-real-time-communication.md#L10-L26]
- Use `node-appwrite` SDK for server-side money flow data fetching to minimize client bundle [Source: docs/architecture/6-tech-stack.md#L49]
- Pass initial money flow data to Client Component via props for hydration [Source: docs/architecture/8-coding-standards.md#L56-L62]

**Client Component Optimization:**
- Extend existing EntrantsGrid Client Component to include Money Flow column for real-time updates (AC #2) [Source: docs/architecture/4-frontend-real-time-communication.md#L40-L48]
- Preserve existing `React.memo()` optimization on EntrantsGrid component to prevent unnecessary re-renders [Source: docs/architecture/8-coding-standards.md#L71-L76]
- Use `useMemo()` for money flow percentage calculations and formatting within the grid [Source: docs/architecture/8-coding-standards.md#L97-L105]
- Bundle size constraint: keep additions minimal to stay under 500KB dashboard target [Source: docs/architecture/6-tech-stack.md#L85]

**Performance Targets:**
- Maintain existing Core Web Vitals performance targets: LCP <2.5s, FID <100ms, CLS <0.1 [Source: docs/architecture/6-tech-stack.md#L77-L79]
- Real-time money flow updates must propagate to UI within <2 seconds [Source: docs/architecture/6-tech-stack.md#L84]
- Bundle size must remain <500KB for main dashboard page [Source: docs/architecture/6-tech-stack.md#L85]

### Appwrite Best Practices

**Server-Side Data Fetching:**
- Server Component extends existing `createServerClient()` pattern for initial money flow data [Source: docs/architecture/8-coding-standards.md#L167-L182]
- Query optimization: efficient money flow lookup by entrant relationship with appropriate indexing [Source: docs/architecture/4-frontend-real-time-communication.md#L154]

**Client-Side Real-Time Updates:**
- Extend existing real-time subscription in `useRealtimeEntrants` hook to include money-flow-history collection [Source: docs/architecture/4-frontend-real-time-communication.md#L170-L175]
- Use optimized subscription patterns to avoid broad subscription overhead [Source: docs/architecture/4-frontend-real-time-communication.md#L147-L151]
- Implement update batching for rapid money flow changes to prevent UI thrashing [Source: docs/architecture/4-frontend-real-time-communication.md#L148-L150]

### File Locations

Based on existing structure and architecture requirements:
- Extend existing `client/src/components/race-view/EntrantsGrid.tsx` component to include Money Flow column [Source: docs/architecture/7-source-tree.md#L27]
- Money Flow integration into existing `/race/[id]/page.tsx` Server Component [Source: docs/stories/4.2.create-entrants-data-grid.md#L130]
- Extend TypeScript interfaces in `client/src/types/meetings.ts` to include money flow fields [Source: docs/architecture/8-coding-standards.md#L17-L19]
- Extend existing `client/src/hooks/useRealtimeEntrants.ts` hook for money flow real-time updates [Source: docs/stories/4.2.create-entrants-data-grid.md#L224]

### UI Design Requirements

Based on UI spec requirements from enhanced wireframe Screen 1:
- Money Flow column labeled as "Money%" positioned between Place Odds and Trend columns [Source: docs/UI-UX-Spec.md#L49-L55]
- Use monospace font (JetBrains Mono) for money flow percentage display to ensure alignment [Source: docs/UI-UX-Spec.md#L114]
- Implement trend indicators (↑↓) for money flow movement with color coding [Source: docs/UI-UX-Spec.md#L106-L108]
- Typography: 14px body text for money flow percentage values [Source: docs/UI-UX-Spec.md#L113-L119]
- Apply 8px grid system for consistent spacing between new column [Source: docs/UI-UX-Spec.md#L124]
- Color system: red/pink for increasing money flow (↑), blue/purple for decreasing money flow (↓) [Source: docs/UI-UX-Spec.md#L106-L108]
- Percentage format: Display with 2 decimal places (e.g., "33.58%") [Source: docs/UI-UX-Spec.md#L51]

### Accessibility Requirements

- Maintain existing semantic table structure with proper `<th>` header for Money Flow column [Source: docs/UI-UX-Spec.md#L147-L152]
- Include ARIA labels for Money Flow column and trend indicators [Source: docs/UI-UX-Spec.md#L147-L152]
- Ensure 4.5:1 contrast ratio for money flow percentage text and trend indicators [Source: docs/UI-UX-Spec.md#L155-L160]
- Extend existing live regions to announce money flow changes to screen readers [Source: docs/UI-UX-Spec.md#L150]
- Keyboard navigation support maintained for new column content [Source: docs/UI-UX-Spec.md#L141-L145]

### Technical Constraints

- Must preserve existing TypeScript strict configuration [Source: docs/architecture/8-coding-standards.md#L5-L13]
- Follow established naming conventions: PascalCase for components, camelCase for functions [Source: docs/architecture/8-coding-standards.md#L16-L21]
- No direct NZTAB API calls client-side - use existing Appwrite data path [Source: docs/architecture/8-coding-standards.md#L200-L204]
- Maintain existing error boundary and loading state patterns from Stories 4.1 and 4.2 [Source: docs/stories/4.2.create-entrants-data-grid.md#L97]

### Testing Requirements

Based on established testing strategy:
- Extend existing EntrantsGrid component tests to include Money Flow column display and real-time updates [Source: docs/architecture/8-coding-standards.md#L206-L214]
- Test Money Flow column renders correctly with proper percentage formatting and trend indicators [Source: docs/architecture/8-coding-standards.md#L214-L224]
- Test real-time money flow updates and trend indicator functionality [Source: docs/architecture/8-coding-standards.md#L206-L214]
- Extend existing accessibility testing to include Money Flow column ARIA attributes [Source: docs/architecture/8-coding-standards.md#L206-L214]
- Performance testing to ensure no bundle size increase beyond limits [Source: docs/architecture/8-coding-standards.md#L237-L244]
- Mock Appwrite SDK calls for money flow data in unit tests [Source: docs/architecture/8-coding-standards.md#L249]

### Project Structure Notes

- Money Flow column will be added to existing EntrantsGrid component structure
- Integration with existing `/race/[id]/page.tsx` Server Component without disrupting RaceHeader or existing entrants grid functionality
- May require extension of existing TypeScript interface definitions for money flow data model

## Tasks / Subtasks

- [ ] T1: Extend Entrant TypeScript interface for money flow data (AC: 1,2)
  - [ ] ST1.1: Add money flow percentage fields to existing Entrant interface
  - [ ] ST1.2: Include trend tracking fields for money flow changes
  - [ ] ST1.3: Update interface to support MoneyFlowHistory relationship

- [ ] T2: Extend server-side data fetching for money flow data (AC: 1,2)
  - [ ] ST2.1: Modify `/race/[id]/page.tsx` Server Component to fetch money flow data
  - [ ] ST2.2: Use `createServerClient()` and `node-appwrite` SDK to query MoneyFlowHistory
  - [ ] ST2.3: Pass money flow data to EntrantsGrid component via props

- [ ] T3: Add Money Flow column to EntrantsGrid component (AC: 1,3)
  - [ ] ST3.1: Add Money Flow column header to existing table structure
  - [ ] ST3.2: Display money flow percentage with proper formatting (2 decimal places)
  - [ ] ST3.3: Apply UI specification styling (monospace font, spacing, visual distinction)
  - [ ] ST3.4: Position column between Place Odds and Trend columns per wireframe

- [ ] T4: Implement real-time money flow updates (AC: 2)
  - [ ] ST4.1: Extend existing `useRealtimeEntrants` hook to subscribe to money-flow-history collection
  - [ ] ST4.2: Add money flow trend indicators (↑↓) with color coding
  - [ ] ST4.3: Implement update batching for rapid money flow changes
  - [ ] ST4.4: Preserve existing update optimization patterns

- [ ] T5: Apply accessibility requirements for Money Flow column (AC: 1,3)
  - [ ] ST5.1: Add semantic table header with proper ARIA labels
  - [ ] ST5.2: Extend existing live regions for money flow update announcements
  - [ ] ST5.3: Ensure proper keyboard navigation and focus management for new column
  - [ ] ST5.4: Verify contrast ratios meet WCAG 2.1 AA standards for new content

- [ ] T6: Performance optimizations for Money Flow feature (AC: 2)
  - [ ] ST6.1: Maintain React.memo() optimization on EntrantsGrid component
  - [ ] ST6.2: Use useMemo() for money flow calculations and formatting
  - [ ] ST6.3: Optimize real-time subscription to avoid unnecessary money flow updates
  - [ ] ST6.4: Ensure bundle size stays within 500KB limit

- [ ] T7: Testing implementation for Money Flow column (AC: 1,2,3)
  - [ ] ST7.1: Extend component tests for Money Flow column display and data rendering
  - [ ] ST7.2: Test real-time money flow updates and trend indicator functionality
  - [ ] ST7.3: Add accessibility tests for Money Flow column ARIA attributes
  - [ ] ST7.4: Performance test to ensure no bundle size regression
  - [ ] ST7.5: Mock MoneyFlowHistory collection calls for unit testing

## Dev Agent Record

### Agent Model Used
- Primary: Claude Sonnet 4 (claude-sonnet-4-20250514)
- Development completed using James (Full Stack Developer) agent persona

### Debug Log References
- No critical issues encountered during development
- TypeScript interface extensions completed successfully
- Real-time subscription implementation working correctly
- All tests passing with comprehensive coverage

### Completion Notes
- Successfully implemented Money Flow column displaying holdPercentage data from MoneyFlowHistory collection
- Added real-time money flow updates with trend indicators (↑↓) and color coding (red for increasing, blue for decreasing)
- Extended TypeScript interfaces in client/src/types/meetings.ts to include money flow fields
- Modified server-side data fetching in client/src/app/race/[id]/page.tsx to query MoneyFlowHistory collection
- Enhanced EntrantsGrid component with Money Flow column positioned between Place Odds and existing trend columns
- Extended useRealtimeEntrants hook to subscribe to money-flow-history collection for real-time updates
- Maintained all existing performance optimizations (React.memo, useMemo) and accessibility standards
- Comprehensive test coverage implemented for Money Flow functionality including trend indicators and live region announcements
- All acceptance criteria met: Money Flow column present for every entrant, values match backend data, column is visually distinct

### File List
Modified Files:
- client/src/types/meetings.ts - Extended Entrant interface with money flow fields
- client/src/app/race/[id]/page.tsx - Added MoneyFlowHistory data fetching
- client/src/components/race-view/EntrantsGrid.tsx - Added Money Flow column with trend indicators
- client/src/hooks/useRealtimeEntrants.ts - Extended for money flow real-time updates
- client/src/components/race-view/__tests__/EntrantsGrid.test.tsx - Extended tests for money flow functionality
- client/src/hooks/__tests__/useRealtimeEntrants.test.ts - Updated tests for dual subscription model

New Files:
- None

### Change Log

| Date       | Version | Description                                                                 | Author             |
| ---------- | ------- | --------------------------------------------------------------------------- | ------------------ |
| 2025-08-11 | 1.0     | Initial draft created with comprehensive architecture-sourced Dev Notes and detailed task breakdown | Bob (Scrum Master) |
| 2025-08-11 | 2.0     | Story implementation completed - Money Flow column with real-time updates and trend indicators successfully implemented | James (Dev Agent) |