# Story 4.9: Implement Place Pool and Odds Flow

## Status

Approved

## Story

**As a** race data analyst,  
**I want** to see both Place pool money flow and Fixed Win odds history in the Enhanced Race Entrants grid alongside the existing Win pool money flow,  
**so that** I can analyze betting patterns across all pool types and track odds movements over time for comprehensive race insights.

## Acceptance Criteria

1. **Place Pool Money Flow Implementation:**

   - [ ] Place selector button shows Place pool money flow data when selected
   - [ ] Place pool timeline columns display incremental money amounts for Place betting
   - [ ] Place pool data follows same timeline structure as Win pool (60m, 55m, 50m, etc.)
   - [ ] Pool column shows total Place pool amount for each entrant when Place is selected
   - [ ] Pool% column shows percentage of total Place pool for each entrant when Place is selected

2. **Odds Flow Implementation:**

   - [ ] Odds selector button shows Fixed Win odds history when selected
   - [ ] Odds timeline columns display the last polled Fixed Win odds value for each time bucket
   - [ ] Odds values show actual odds (not incremental differences like money flow)
   - [ ] Odds display shows current/latest odds value within each time interval
   - [ ] Pool column continues to show Win pool amount (unchanged from Win view) when Odds is selected
   - [ ] Pool% column continues to show Win pool percentage (unchanged from Win view) when Odds is selected

3. **Enhanced Entrants Grid Integration:**

   - [ ] Three selector buttons (Win, Place, Odds) allow switching between data views
   - [ ] Win selector continues to show existing Win pool money flow functionality
   - [ ] Timeline grid adapts column content based on selected view type
   - [ ] All selectors maintain same UI/UX patterns as existing Win selector

4. **Data Structure and Backend Integration:**

   - [ ] Place pool data uses same `money-flow-history` collection with `poolType` field
   - [ ] Odds data uses existing `odds-history` collection with proper time indexing
   - [ ] Timeline calculations work for both incremental money flow and point-in-time odds values
   - [ ] Real-time updates work for all three data types (Win, Place, Odds)

5. **Real-time Data Updates:**
   - [ ] All three view types (Win, Place, Odds) update automatically via Appwrite subscriptions
   - [ ] View switching is instantaneous with cached data
   - [ ] Component maintains performance with expanded data requirements

## Tasks / Subtasks

- [ ] **Analyze Current Win Pool Implementation** (AC: 1,3)

  - [ ] Review existing Win pool money flow logic in `EnhancedEntrantsGrid.tsx`
  - [ ] Examine `useMoneyFlowData.ts` hook for data fetching patterns
  - [ ] Document current timeline calculation methodology
  - [ ] Identify reusable components for Place pool implementation

- [ ] **Implement Place Pool Money Flow** (AC: 1,3)

  - [ ] Extend `useMoneyFlowData.ts` to fetch Place pool data from `money-flow-history`
  - [ ] Add Place pool filtering logic using `poolType` field or similar identifier
  - [ ] Implement Place pool incremental calculation (same as Win pool methodology)
  - [ ] Update `MoneyFlowColumns.tsx` to display Place pool amounts and percentages

- [ ] **Implement Odds Flow Data Structure** (AC: 2,3,4)

  - [ ] Create new hook `useOddsHistory.ts` to fetch Fixed Win odds over time
  - [ ] Query `odds-history` collection with proper time interval matching
  - [ ] Implement point-in-time odds retrieval (latest value per time bucket)
  - [ ] Adapt timeline grid to display odds values instead of money increments
  - [ ] Ensure Pool/Pool% columns remain showing Win pool data when Odds view is selected

- [ ] **Enhance Pool Toggle Component** (AC: 3)

  - [ ] Implement state management for current selected view
  - [ ] Add proper styling and active state indicators
  - [ ] Ensure accessible button interactions and keyboard navigation

- [ ] **Update Timeline Grid Display Logic** (AC: 1,2,3)

  - [ ] Modify `EnhancedEntrantsGrid.tsx` to handle three different data types
  - [ ] Implement conditional rendering for timeline columns based on selected pool view
  - [ ] Update timeline column headers to reflect current data type (Money vs Odds)
  - [ ] Ensure Pool/Pool% columns respond correctly to Win/Place selection but remain Win values for Odds
  - [ ] Ensure proper formatting for currency (Place/Win) vs odds values in timeline

- [ ] **Extend Real-time Subscriptions** (AC: 4,5)

  - [ ] Update Appwrite subscriptions to include Place pool and odds changes
  - [ ] Optimize subscription management to avoid unnecessary re-renders
  - [ ] Implement proper cache invalidation for all three data types
  - [ ] Test real-time performance with expanded subscription scope

- [ ] **Testing and Validation** (AC: 1,2,3,4,5)
  - [ ] Test Place pool data accuracy against NZTAB API responses
  - [ ] Validate Odds history displays correct Fixed Win odds progression
  - [ ] Test view switching performance and data consistency
  - [ ] Verify Pool/Pool% columns behavior: Win values for Win view, Place values for Place view, Win values for Odds view
  - [ ] Verify all three selectors maintain proper real-time updates
  - [ ] Use Playwright MCP server to test complete functionality

## Dev Notes

### Performance Requirements (Next.js 15)

**Server Component Usage:**
[Source: architecture/6-tech-stack.md#612-architecture-pattern]

- Enhanced Race Entrants component maintains Server Component architecture for initial data fetching
- Client Component wrapper handles pool view switching and real-time subscriptions
- Implement data hydration for all three pool types (Win, Place, Odds) in single server fetch

**Bundle Optimization:**
[Source: architecture/6-tech-stack.md#613-performance-optimizations]

- Use dynamic imports for expanded data processing logic if bundle grows >500KB
- Implement proper tree-shaking for additional Appwrite SDK query methods
- Consider code splitting for odds-specific display components

**Real-time Optimization:**
[Source: architecture/6-tech-stack.md#615-state-management]

- Batch subscription updates across all three data types to prevent excessive re-renders
- Use React.memo() for timeline cells with different data types (money vs odds)
- Implement useMemo() for odds history calculations and Place pool mathematics

### Appwrite Best Practices

**SDK Configuration:**
[Source: architecture/6-tech-stack.md#622-appwrite-sdk-strategy]

- Use node-appwrite in Server Components for initial parallel data fetching (Win/Place/Odds)
- Use appwrite web SDK only in Client Components for expanded subscription management
- Implement proper error handling for multiple collection queries

**Database Query Optimization:**
[Source: architecture/4-database-schema-appwrite.md]

- Use compound indexes for `money-flow-history`: (entrant, poolType, pollingTimestamp)
- Optimize `odds-history` queries with (entrant, eventTimestamp) indexing
- Implement Query.select() to fetch only required fields for each view type
- Use parallel queries for Win/Place money flow and odds history data

**Real-time Subscription Management:**
[Source: architecture/3-frontend-architecture-nextjs-15.md#enhanced-grid-component-architecture]

- Subscribe to both `money-flow-history` and `odds-history` collections efficiently
- Use structured channels for different pool types: `race:{id}:win`, `race:{id}:place`, `race:{id}:odds`
- Implement proper subscription cleanup with expanded channel management

### Source Tree Context

[Source: architecture/7-source-tree.md]

**Component Location:** `src/components/race/EnhancedEntrantsGrid.tsx`

**New/Modified Components:**

- `src/components/race/PoolToggle.tsx` - Expand to three-button toggle
- `src/components/race/MoneyFlowColumns.tsx` - Support Place pool and odds display
- `src/hooks/useMoneyFlowData.ts` - Extend for Place pool data
- `src/hooks/useOddsHistory.ts` - NEW: Odds timeline data fetching
- `src/services/oddsHistoryService.ts` - NEW: Odds data service layer
- `src/types/oddsHistory.ts` - NEW: Odds data type definitions

### Database Schema Context

[Source: architecture/4-database-schema-appwrite.md]

**Primary Collections:**

**money-flow-history:**

- Existing Win pool data structure
- Extend with Place pool data (same schema, different `poolType` or filtering)
- Fields: `winPoolAmount`, `placePoolAmount`, `incrementalWinAmount`, `incrementalPlaceAmount`, `pollingTimestamp`, `timeToStart`

**odds-history:**

- Fixed Win odds over time for sparklines and timeline
- Fields: `odds`, `eventTimestamp`, `type`, `entrant` (relationship)
- Use for point-in-time odds retrieval per timeline bucket

**Key Indexes:**

- `money-flow-history`: `idx_entrant_pooltype_timestamp` (compound), `idx_race_time_interval` (compound)
- `odds-history`: `idx_entrant_timestamp` (compound), `idx_event_timestamp`

### Testing Requirements

**Component Testing:**

- Test three-way pool toggle state management and view switching
- Test Place pool calculation accuracy with mock data matching Win pool methodology
- Test odds display formatting and timeline progression
- Test Pool/Pool% column behavior: displays Place values for Place view, Win values for Win and Odds views
- Test real-time subscription behavior for all three data types

**Integration Testing:**

- Test end-to-end Place pool data pipeline from NZTAB API to UI
- Validate odds history data accuracy against NZTAB API responses
- Test view switching performance and data consistency
- Test historical data display for completed races across all pool types

**Performance Testing:**

- Monitor timeline grid performance with tripled data requirements
- Test real-time update performance with expanded subscription scope
- Verify bundle size remains within Next.js 15 targets with additional features

**MCP Server Testing Strategy:**

- Use Context7 MCP server to research Appwrite multi-collection query patterns
- Use Playwright MCP server for comprehensive UI testing:
  - Test three-way pool selector functionality (Win/Place/Odds)
  - Verify Place pool money flow displays correctly with incremental calculations
  - Test odds timeline shows proper point-in-time values (not increments)
  - Test Pool/Pool% columns show correct values: Place for Place view, Win for Win and Odds views
  - Validate real-time updates work for all three view types
  - Test responsive grid performance with expanded data scope

### Previous Story Context

From Story 4.8 (Performance Optimization): Component architecture optimized for real-time updates provides foundation for expanded data types.

From Story 4.5 (Automatic Data Updates): Existing real-time subscription infrastructure can be extended for Place pool and odds data.

From existing Story 4.9: Win pool money flow implementation provides pattern to follow for Place pool. Critical issues with real-time data connection must be resolved first.

## Change Log

| Date       | Version | Description                                                        | Author             |
| ---------- | ------- | ------------------------------------------------------------------ | ------------------ |
| 2025-09-09 | 1.0     | Recreation of Story 4.9 with Place pool and Odds flow requirements | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be populated by development agent_

### Debug Log References

_To be populated by development agent_

### Completion Notes List

_To be populated by development agent_

### File List

_To be populated by development agent_

## QA Results

_To be populated by QA Agent_
