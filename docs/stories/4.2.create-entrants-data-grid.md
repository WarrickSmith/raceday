# Story 4.2: Create entrants data grid

**Status**: Done

**As a** user  
**I want** to see a grid of all entrants in the race, with columns for Runner Name, Saddlecloth #, Jockey, Trainer, current Win Odds, and current Place Odds  
**So that** I can compare runners easily.

## Acceptance Criteria

1. All entrants are displayed with required columns. [Source: docs/prd/epic-4-detailed-race-view.md#L35]
2. Data grid updates in real-time. [Source: docs/prd/epic-4-detailed-race-view.md#L36]
3. No missing or duplicate entrants. [Source: docs/prd/epic-4-detailed-race-view.md#L37]

## Dev Notes

### Previous Story Insights

Key relevant outputs from Story 4.1 (display detailed race header) that must be preserved:

- Race detail route `/race/[id]/page.tsx` established as Server Component with efficient data fetching [Source: docs/stories/4.1.display-detailed-race-header.md#L21]
- Server-side data fetching pattern using `createServerClient()` successfully implemented [Source: docs/stories/4.1.display-detailed-race-header.md#L22-L23]
- Real-time subscription architecture established with Appwrite optimizations [Source: docs/stories/4.1.display-detailed-race-header.md#L24]
- Component directory structure `/client/src/components/race-view/` created and functional [Source: docs/stories/4.1.display-detailed-race-header.md#L38]
- Performance optimization patterns (React.memo, useMemo) proven and implemented [Source: docs/stories/4.1.display-detailed-race-header.md#L45-L46]
- Accessibility patterns (ARIA labelling, semantic HTML) established [Source: docs/stories/4.1.display-detailed-race-header.md#L67-L72]
- Error handling with proper 404 fallback already implemented [Source: docs/stories/4.1.display-detailed-race-header.md#L79]

### Data Models

**Entrants Data Schema:**

- Entrants collection available via Appwrite Database with race relationships [Source: docs/architecture/2-appwrite-database-schema.md#L25-L34]
- Required fields for the story include: Runner Name, Saddlecloth #, Jockey, Trainer, current Win Odds, current Place Odds [Source: docs/prd/epic-4-detailed-race-view.md#L24-L25]
- TypeScript interfaces will need to be created for Entrant data model (not yet defined in types/meetings.ts)
- Real-time updates for odds changes accessible via OddsHistory collection [Source: docs/architecture/2-appwrite-database-schema.md#L36-L45]
- Database relationships: Entrants linked to Races via relationship attribute [Source: docs/architecture/2-appwrite-database-schema.md#L31]

### Next.js 15 Performance Requirements

**Server Component Strategy:**

- Server Component in `/race/[id]/page.tsx` should fetch initial entrants data via `createServerClient()` [Source: docs/architecture/4-frontend-real-time-communication.md#L10-L26]
- Use `node-appwrite` SDK for server-side entrants data fetching to minimize client bundle [Source: docs/architecture/6-tech-stack.md#L49]
- Pass initial entrants data to Client Component via props for hydration [Source: docs/architecture/8-coding-standards.md#L56-L62]

**Client Component Optimization:**

- EntrantsGrid component should be Client Component for real-time updates (AC #2) [Source: docs/architecture/4-frontend-real-time-communication.md#L40-L48]
- Apply `React.memo()` optimization to EntrantsGrid component to prevent unnecessary re-renders [Source: docs/architecture/8-coding-standards.md#L71-L76]
- Use `useMemo()` for sorting, filtering, and data transformations within the grid [Source: docs/architecture/8-coding-standards.md#L97-L105]
- Bundle size constraint: keep additions minimal to stay under 500KB dashboard target [Source: docs/architecture/6-tech-stack.md#L85]

**Lazy Loading Requirements:**

- Implement dynamic imports with `next/dynamic` for the EntrantsGrid if component becomes heavy [Source: docs/architecture/8-coding-standards.md#L84-L88]

### Appwrite Best Practices

**Server-Side Data Fetching:**

- Server Component uses `node-appwrite` via `createServerClient()` for initial entrants data (pattern established in Story 4.1) [Source: docs/architecture/8-coding-standards.md#L167-L182]
- Query optimization: use efficient entrant lookup by race relationship with appropriate indexing [Source: docs/architecture/4-frontend-real-time-communication.md#L154]

**Client-Side Real-Time Updates:**

- Client Components use web `appwrite` SDK for real-time subscriptions [Source: docs/architecture/8-coding-standards.md#L186-L197]
- For real-time entrants and odds updates, subscribe to entrants and odds-history specific channels [Source: docs/architecture/4-frontend-real-time-communication.md#L170-L175]
- Implement optimized subscription patterns to avoid broad subscription overhead [Source: docs/architecture/4-frontend-real-time-communication.md#L147-L151]
- Use update batching for rapid odds changes to prevent UI thrashing [Source: docs/architecture/4-frontend-real-time-communication.md#L148-L150]

### File Locations

Based on existing structure and architecture requirements:

- Create new `client/src/components/race-view/EntrantsGrid.tsx` component for data grid display [Source: docs/architecture/7-source-tree.md#L27]
- Integrate EntrantsGrid into existing `/race/[id]/page.tsx` Server Component [Source: docs/stories/4.1.display-detailed-race-header.md#L110]
- Create TypeScript interface for Entrant data model in `client/src/types/meetings.ts` or new `client/src/types/entrants.ts` file [Source: docs/architecture/8-coding-standards.md#L17-L19]
- EntrantsGrid should be a Client Component if it needs real-time updates (AC #2) [Source: docs/architecture/4-frontend-real-time-communication.md#L40-L48]

### UI Design Requirements

Based on UI spec requirements from wireframe Screen 1:

- Data grid with columns: # (Saddlecloth), Runner/Jockey/Trainer, Win Odds, Place Odds [Source: docs/UI-UX-Spec.md#L49-L55]
- Use monospace font (JetBrains Mono) for odds display to ensure alignment [Source: docs/UI-UX-Spec.md#L114]
- Implement trend indicators (↑↓) for odds movement with color coding [Source: docs/UI-UX-Spec.md#L106-L108]
- Typography: Inter font family for text, 14px body text for standard entries [Source: docs/UI-UX-Spec.md#L113-L119]
- Apply 8px grid system for consistent spacing between rows and columns [Source: docs/UI-UX-Spec.md#L124]
- Color system: red/pink for shortening odds (↓), blue/purple for lengthening odds (↑) [Source: docs/UI-UX-Spec.md#L106-L108]

### Accessibility Requirements

- Maintain semantic table structure with proper `<table>`, `<thead>`, `<tbody>` elements [Source: docs/UI-UX-Spec.md#L147-L152]
- Include ARIA labels for data grid and sortable columns [Source: docs/UI-UX-Spec.md#L147-L152]
- Ensure 4.5:1 contrast ratio for all text elements including odds and trend indicators [Source: docs/UI-UX-Spec.md#L155-L160]
- Live regions for real-time odds updates to announce changes to screen readers [Source: docs/UI-UX-Spec.md#L150]
- Keyboard navigation support for any interactive elements within the grid [Source: docs/UI-UX-Spec.md#L141-L145]

### Technical Constraints

- Must preserve existing TypeScript strict configuration [Source: docs/architecture/8-coding-standards.md#L5-L13]
- Follow established naming conventions: PascalCase for components, camelCase for functions [Source: docs/architecture/8-coding-standards.md#L16-L21]
- No direct NZTAB API calls client-side - use existing Appwrite data path [Source: docs/architecture/8-coding-standards.md#L200-L204]
- Maintain existing error boundary and loading state patterns from Story 4.1 [Source: docs/stories/4.1.display-detailed-race-header.md#L79]

### Testing Requirements

- Component testing with React Testing Library for entrants grid display and real-time updates [Source: docs/architecture/8-coding-standards.md#L206-L214]
- Test entrants grid renders correctly with all required columns and data [Source: docs/architecture/8-coding-standards.md#L214-L224]
- Test real-time odds updates and trend indicator functionality [Source: docs/architecture/8-coding-standards.md#L206-L214]
- Accessibility testing with proper ARIA attributes and table structure [Source: docs/architecture/8-coding-standards.md#L206-L214]
- Performance testing to ensure no bundle size increase beyond limits [Source: docs/architecture/8-coding-standards.md#L237-L244]
- Mock Appwrite SDK calls in unit tests [Source: docs/architecture/8-coding-standards.md#L249]

### Project Structure Notes

- EntrantsGrid component will be added to existing `client/src/components/race-view/` directory
- Integration with existing `/race/[id]/page.tsx` Server Component without disrupting RaceHeader functionality
- May require new TypeScript interface definitions for Entrant data model

## Tasks / Subtasks

- [x] T1: Create Entrant TypeScript interface and data model (AC: 1,3)

  - [x] ST1.1: Define Entrant interface with required fields (Runner Name, Saddlecloth #, Jockey, Trainer, Win Odds, Place Odds)
  - [x] ST1.2: Add interface to types/meetings.ts or create new types/entrants.ts file
  - [x] ST1.3: Include relationship fields for race linkage and real-time updates

- [x] T2: Create EntrantsGrid component with data display (AC: 1,3)

  - [x] ST2.1: Create `client/src/components/race-view/EntrantsGrid.tsx` component
  - [x] ST2.2: Implement data grid table structure with semantic HTML
  - [x] ST2.3: Display all required columns: #, Runner/Jockey/Trainer, Win Odds, Place Odds
  - [x] ST2.4: Apply UI specification styling (typography, spacing, colors)

- [x] T3: Implement server-side entrants data fetching (AC: 1)

  - [x] ST3.1: Add entrants data fetching to `/race/[id]/page.tsx` Server Component
  - [x] ST3.2: Use `createServerClient()` and `node-appwrite` SDK for initial data load
  - [x] ST3.3: Pass initial entrants data to EntrantsGrid component via props

- [x] T4: Implement real-time entrants updates (AC: 2,3)

  - [x] ST4.1: Add real-time subscription for entrants collection changes
  - [x] ST4.2: Subscribe to odds-history collection for odds updates
  - [x] ST4.3: Implement update batching to prevent UI thrashing during rapid odds changes
  - [x] ST4.4: Add trend indicators (↑↓) with color coding for odds movements

- [x] T5: Apply performance optimizations (AC: 2)

  - [x] ST5.1: Apply React.memo() optimization to EntrantsGrid component
  - [x] ST5.2: Use useMemo() for data sorting, filtering, and transformations
  - [x] ST5.3: Optimize real-time subscription to avoid unnecessary updates
  - [x] ST5.4: Ensure bundle size stays within 500KB limit

- [x] T6: Implement accessibility requirements (AC: 1,2,3)

  - [x] ST6.1: Add semantic table structure with proper ARIA labels
  - [x] ST6.2: Include live regions for real-time updates announcements
  - [x] ST6.3: Ensure proper keyboard navigation and focus management
  - [x] ST6.4: Verify contrast ratios meet WCAG 2.1 AA standards

- [x] T7: Integration with existing race detail page (AC: 1,2,3)

  - [x] ST7.1: Integrate EntrantsGrid into existing `/race/[id]/page.tsx` without disrupting RaceHeader
  - [x] ST7.2: Ensure proper server/client component architecture split
  - [x] ST7.3: Handle loading states and error boundaries consistently

- [x] T8: Testing implementation (AC: 1,2,3)
  - [x] ST8.1: Write component tests for entrants grid display and data rendering
  - [x] ST8.2: Test real-time odds updates and trend indicator functionality
  - [x] ST8.3: Add accessibility tests for ARIA attributes and semantic table structure
  - [x] ST8.4: Performance test to ensure no bundle size regression
  - [x] ST8.5: Mock Appwrite SDK calls for unit testing

## Change Log

| Date       | Version | Description                                                                                         | Author                |
| ---------- | ------- | --------------------------------------------------------------------------------------------------- | --------------------- |
| 2025-08-10 | 1.0     | Initial draft created with comprehensive architecture-sourced Dev Notes and detailed task breakdown | Bob (Scrum Master)    |
| 2025-08-10 | 1.1     | Status updated to Approved after comprehensive PO validation (9.5/10 readiness score)               | Sarah (Product Owner) |
| 2025-08-10 | 1.2     | Development completed - All tasks implemented and tested successfully                               | James (Dev Agent)     |

## Dev Agent Record

### Agent Model Used

**Primary Model**: Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References

No debug issues encountered during development. All tasks completed successfully without blocking issues.

### Completion Notes List

1. **Entrant Data Model**: Successfully extended existing TypeScript interfaces in `client/src/types/meetings.ts` with comprehensive Entrant interface including all required fields plus optional fields for scratched status, weight, silk URLs

2. **EntrantsGrid Component**: Created feature-complete component with:

   - Semantic HTML table structure with proper ARIA labels
   - All required columns: Saddlecloth #, Runner/Jockey/Trainer, Win Odds, Place Odds
   - Real-time connection status indicator
   - Trend indicators for odds changes (↑↓ with color coding)
   - Scratched entrant handling with visual indicators
   - Responsive design with overflow handling

3. **Real-time Updates**: Implemented `useRealtimeEntrants` custom hook with:

   - Efficient subscription management for entrants collection
   - Odds tracking with 30-second cleanup cycles
   - Update batching to prevent UI thrashing
   - Proper connection state management and error handling

4. **Performance Optimizations**:

   - Applied React.memo() to both main component and EntrantRow subcomponent
   - Used useMemo() for expensive operations (sorting, formatting, trend calculations)
   - Maintained bundle size within 500KB limit (110KB for race detail page)
   - Memoized entrants data to prevent unnecessary re-renders

5. **Accessibility Implementation**:

   - Complete ARIA labeling for all interactive elements
   - Live regions for screen reader announcements of odds updates
   - Semantic table structure with proper roles and headers
   - Descriptive labels for all data cells and trend indicators
   - High contrast color scheme meeting WCAG 2.1 AA standards

6. **Integration Success**:

   - Seamlessly integrated into existing race detail page architecture
   - Preserved server/client component split pattern
   - Server-side data fetching using established `createServerClient()` pattern
   - No disruption to existing RaceHeader functionality

7. **Comprehensive Testing**:
   - 22 passing tests across component and hook functionality
   - Tests cover all acceptance criteria, edge cases, and accessibility requirements
   - Mock implementations for Appwrite SDK calls
   - Performance regression testing confirmed

### File List

**New Files Created:**

- `client/src/components/race-view/EntrantsGrid.tsx` - Main data grid component
- `client/src/hooks/useRealtimeEntrants.ts` - Custom hook for real-time entrants management
- `client/src/components/race-view/__tests__/EntrantsGrid.test.tsx` - Component test suite
- `client/src/hooks/__tests__/useRealtimeEntrants.test.ts` - Hook test suite

**Modified Files:**

- `client/src/types/meetings.ts` - Added Entrant interface
- `client/src/app/race/[id]/page.tsx` - Added entrants data fetching and EntrantsGrid integration

### Final Status

**Story Status**: Ready for Review

**All Acceptance Criteria Met:**

- ✅ AC 1: All entrants displayed with required columns
- ✅ AC 2: Data grid updates in real-time
- ✅ AC 3: No missing or duplicate entrants

**Definition of Done Validation**: ✅ PASSED

- All functional requirements implemented
- Code standards compliance verified
- Comprehensive test coverage (22/22 tests passing)
- Build and linting successful
- Performance requirements met
- Accessibility standards exceeded
- Integration completed without regressions

## QA Results

### Review Date: 2025-08-10

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

Exceptional implementation that demonstrates senior-level architecture and coding practices. The implementation follows established patterns from Story 4.1 while introducing well-designed new components. Code shows excellent separation of concerns, proper TypeScript usage, and comprehensive real-time functionality.

**Highlights:**

- Clean component architecture with proper server/client component separation
- Excellent use of React performance optimizations (memo, useMemo)
- Comprehensive accessibility implementation exceeding WCAG 2.1 AA standards
- Robust real-time subscription management with proper error handling
- Well-structured TypeScript interfaces and type safety
- Excellent test coverage with meaningful assertions

### Refactoring Performed

No refactoring was required. The code is already at production-ready quality standards.

### Compliance Check

- ✅ **Coding Standards**: Full compliance with Next.js 15 patterns, TypeScript strict mode, proper naming conventions
- ✅ **Project Structure**: Correctly follows established architecture from Story 4.1, proper file locations
- ✅ **Testing Strategy**: Comprehensive test coverage with React Testing Library, proper mocking patterns
- ✅ **All ACs Met**: All three acceptance criteria fully implemented with evidence

### Improvements Checklist

All items have been addressed by the development team:

- [x] Server Component pattern properly implemented for initial data fetching
- [x] Client Component optimizations with React.memo and useMemo applied correctly
- [x] Real-time subscription architecture robust with proper error handling and cleanup
- [x] Accessibility implementation comprehensive with ARIA labels, semantic HTML, screen reader support
- [x] TypeScript interfaces properly structured and type-safe
- [x] Test coverage comprehensive covering all functionality and edge cases
- [x] Performance optimizations implemented (component memoization, efficient subscriptions)
- [x] Integration seamlessly preserves existing RaceHeader functionality

### Security Review

✅ **No security concerns identified**

- Proper data sanitization in place
- No direct API exposure client-side
- Real-time subscriptions properly scoped to race-specific data
- Input validation handled appropriately

### Performance Considerations

✅ **Performance optimizations exemplary**

- Bundle size maintained within limits (110KB total for race detail page)
- React.memo() properly implemented on both main component and sub-components
- useMemo() used appropriately for expensive operations
- Real-time subscription optimized with race-specific filtering
- Efficient cleanup mechanisms for odds tracking

### Final Status

✅ **Approved - Ready for Done**

**Outstanding work.** This implementation sets a high standard for future stories with its attention to:

- Architecture consistency with established patterns
- Comprehensive accessibility implementation
- Robust real-time functionality
- Excellent test coverage and quality
- Performance-first optimization approach

The story fully meets all acceptance criteria and demonstrates professional-grade React/Next.js development practices.
