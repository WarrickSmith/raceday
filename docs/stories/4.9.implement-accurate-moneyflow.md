# Story 4.9: Implement Accurate Moneyflow

## Status

In Progress - Critical Issues Discovered

## Story

**As a** race data analyst,  
**I want** to see accurate money flow timeline data in the Enhanced Race Entrants component that displays real-time cumulative and incremental pool amounts for Win/Place pools,  
**so that** I can track betting patterns and market momentum throughout the pre-race period and understand how money flows into different pools over time.

## Acceptance Criteria

1. **Pool Toggle Functionality:**

   - [x] Win/Place pool buttons correctly switch the displayed data in timeline grid and Pool/Pool% columns
   - [x] Quinella button is removed as specified in brief
   - [x] Default view is Win pool data

2. **Timeline Grid Data Accuracy:**

   - [ ] Timeline columns display incremental money amounts bet since the previous time point (not cumulative totals)
   - [ ] Grid shows data in real-time up to current time (-30m if race starts in 30 minutes)
   - [ ] Future time columns show "-" placeholder when no data exists yet
   - [ ] Data displays correctly for races navigated to before, during, or after finalization

3. **Pool and Pool% Column Accuracy:**

   - [ ] Pool column shows total pool amount for selected pool type (Win/Place) for each entrant ‚ùå **CRITICAL: Shows dummy fallback data ($12, 14.29%) instead of real API data**
   - [ ] Pool% column shows percentage of total race pool that each entrant represents ‚ùå **CRITICAL: All entrants show identical percentages, math doesn't add up to totals**
   - [x] Values update correctly when pool toggle buttons are switched

4. **Real-time Data Updates:**

   - [ ] Component subscribes to Appwrite DB changes and reflects updates instantly ‚ùå **CRITICAL: Shows "No updates yet" despite API having live data**
   - [ ] Timeline grid updates automatically as new polling data arrives ‚ùå **CRITICAL: Real-time connection broken**
   - [ ] All money flow displays update without page refresh ‚ùå **CRITICAL: Dummy data displayed instead of live updates**

5. **Data Structure and Backend:**
   - [x] Backend Appwrite functions correctly save money flow history data with proper time attribution ‚úÖ **CONFIRMED: API returns real data (holdPercentage: 28, winPoolAmount: 344)**
   - [ ] Data calculations handle cumulative vs incremental display logic correctly ‚ùå **ISSUE: Frontend not using real API data**
   - [x] Historical data is retained and can be displayed for completed races ‚úÖ **CONFIRMED: Database contains 876+ records**

## Current Implementation Status

### ‚úÖ **WORKING COMPONENTS:**
- **Backend API:** Money flow timeline API successfully returns real data
- **Hook Integration:** `useMoneyFlowTimeline` hook properly integrated and calling API
- **Pool Toggle UI:** Win/Place buttons functional, Quinella removed, default Win view working
- **Data Structure:** Server-client data structure alignment completed

### üî¥ **CRITICAL ISSUES DISCOVERED:**
- **Real-Time Connection Broken:** UI displays "No updates yet" despite API having fresh live data
- **Dummy Data Display:** All entrants show identical fallback values ($12, 14.29%) instead of real API data
- **Math Validation Failed:** Pool amounts don't sum to footer totals (7 √ó $12 = $84 ‚â† $1,230 win pool)
- **Timeline Columns Empty:** All timeline columns show "‚Äî" despite API containing timeline data with timeToStart values

### üìä **LIVE TESTING EVIDENCE:**
**Test Race:** CHRISTCHURCH CASINO 30TH SI AWARDS (ID: 279dc587-bb6e-4a56-b7e5-70d78b942ddd)
- **API Data:** `holdPercentage: 28`, `winPoolAmount: 344`, `placePoolAmount: 178`, `timeToStart: 22`
- **UI Display:** Shows uniform "$12" and "14.29%" for all entrants
- **Status Message:** "Last update: No updates yet"

### üéØ **NEXT ACTIONS:**
1. **Fix Real-Time Data Connection** - Debug why live API data doesn't reach UI
2. **Remove Dummy Data Display** - Show empty/loading states instead of confusing fallback values
3. **Timeline Data Processing** - Fix interval matching logic for timeline columns

## Tasks / Subtasks

- [ ] **Investigate Current Implementation** (AC: 1,2,3,4,5)

  - [ ] Review Enhanced Race Entrants component structure in src/components/race/
  - [ ] Analyze current money flow data structure in Appwrite database
  - [ ] Examine existing pool toggle functionality
  - [ ] Document current issues with timeline grid calculations

- [ ] **Review Backend Data Collection** (AC: 5)

  - [ ] Examine server/daily-meetings/src/database-setup.js for money-flow-history schema
  - [ ] Review race polling strategy documentation at docs/appwrite_race_polling_strategy.md
  - [ ] Analyze NZTAB API data structure from docs/nztab/openapi.json
  - [ ] Verify backend functions are saving required data fields
  - [ ] Use Context7 MCP server to research latest Appwrite SDK capabilities for real-time subscriptions and database interactions

- [ ] **Fix Pool Toggle Functionality** (AC: 1)

  - [ ] Implement proper Win/Place pool data switching in Enhanced Race Entrants component
  - [ ] Remove Quinella button from UI
  - [ ] Ensure default Win pool view on component load
  - [ ] Add proper state management for pool view selection

- [ ] **Correct Timeline Grid Data Display** (AC: 2)

  - [ ] Implement incremental money calculation logic (current total - previous total)
  - [ ] Fix real-time data progression to show data up to current time only
  - [ ] Add placeholder "-" for future time columns
  - [ ] Ensure proper data fetching for historical race views

- [ ] **Fix Pool and Pool% Column Calculations** (AC: 3)

  - [ ] Implement correct total pool amount calculation per entrant
  - [ ] Add percentage calculation relative to total race pool
  - [ ] Ensure values update when pool toggle changes

- [ ] **Enhance Real-time Data Subscriptions** (AC: 4)

  - [ ] Review and optimize Appwrite subscription patterns for money flow updates
  - [ ] Implement proper cache invalidation on data changes
  - [ ] Test real-time updates with multiple clients

- [ ] **Backend Data Structure Verification** (AC: 5)

  - [ ] Verify money-flow-history collection stores incremental and cumulative data
  - [ ] Ensure polling timestamp and time-to-start fields are correctly populated
  - [ ] Test data retention for historical race analysis

- [ ] **Testing and Validation** (AC: 1,2,3,4,5)
  - [ ] Test pool toggle functionality across different race states
  - [ ] Validate timeline grid calculations with known data sets
  - [ ] Test real-time updates during active race polling
  - [ ] Use Playwright MCP server to navigate to race interface and verify Enhanced Race Entrants component behavior
  - [ ] Use Playwright MCP server to test pool toggle switching and data display accuracy
  - [ ] Use Playwright MCP server to verify timeline grid displays correct incremental money flow data

## Dev Notes

### Performance Requirements (Next.js 15)

**Server Component Usage:**

- Enhanced Race Entrants component should be primarily Server Component for initial data fetching
- Use Client Component wrapper only for real-time updates and interactive pool toggles
- Implement proper data hydration pattern with initialData props

**Bundle Optimization:**

- Use dynamic imports for heavy data visualization components if added
- Ensure money flow calculation logic doesn't bloat main bundle
- Implement proper tree-shaking for Appwrite SDK imports

**Real-time Optimization:**

- Batch subscription updates to prevent excessive re-renders
- Use React.memo() for individual timeline cells to optimize grid performance
- Implement useMemo() for expensive money flow calculations

### Appwrite Best Practices

**SDK Configuration:**

- Use node-appwrite in Server Components for initial data fetching
- Use appwrite web SDK only in Client Components for subscriptions
- Implement proper error handling for database queries

**Database Query Optimization:**

- Use indexed queries on money-flow-history with compound indexes (entrant_id, pollingTimestamp)
- Implement proper pagination for large money flow datasets
- Use Query.select() to fetch only required fields

**Real-time Subscription Management:**

- Subscribe to specific entrant money flow changes, not entire collections
- Implement proper cleanup on component unmount
- Use structured channels for different data types (pools, money-flow, odds)
- Use Context7 MCP server to research latest Appwrite real-time subscription patterns and best practices for high-frequency data updates

### Source Tree Context

[Source: architecture/7-source-tree.md]

**Component Location:** src/components/race/EnhancedEntrantsGrid.tsx
**Related Components:**

- src/components/race/MoneyFlowColumns.tsx
- src/components/race/PoolToggle.tsx
- src/hooks/useMoneyFlowData.ts
- src/services/moneyFlowService.ts

**Data Types:** src/types/moneyFlow.ts, src/types/racePools.ts

### Database Schema Context

[Source: architecture/4-database-schema-appwrite.md]

**Primary Collections:**

- money-flow-history: winPoolAmount, placePoolAmount, incrementalAmount, pollingTimestamp, timeToStart, entrant (relationship)
- race-pools: winPoolTotal, placePoolTotal, lastUpdated, race (relationship)
- entrants: winOdds, placeOdds, holdPercentage, race (relationship)

**Key Indexes:** idx_polling_timestamp, idx_entrant_polling (compound), idx_time_to_start

### Testing Requirements

**Component Testing:**

- Test pool toggle state changes and data switching
- Test timeline grid calculations with mock data
- Test real-time subscription behavior with React Testing Library

**Integration Testing:**

- Test end-to-end money flow data pipeline from NZTAB API to UI
- Validate incremental vs cumulative calculations
- Test historical data display for completed races

**Performance Testing:**

- Verify timeline grid rendering performance with large datasets
- Test real-time update performance under high-frequency data changes
- Monitor bundle size impact of money flow features

**MCP Server Testing Strategy:**

- Use Context7 MCP server to research latest Appwrite testing patterns and SDK documentation
- Use Playwright MCP server for comprehensive UI testing:
  - Navigate to race detail pages and verify Enhanced Race Entrants component loads correctly
  - Test pool toggle interactions (Win/Place button switching)
  - Verify timeline grid displays data correctly with proper time column progression
  - Test real-time data updates by monitoring component behavior during data changes
  - Validate money flow calculations display accurately in timeline grid
  - Test responsive behavior and grid performance with large datasets

### Previous Story Context

From Story 4.8 (Performance Optimization): Component architecture has been optimized for real-time updates with proper subscription management and performance monitoring.

From Story 4.5 (Automatic Data Updates): Real-time subscription infrastructure exists but may need enhancement for money flow specific data patterns.

From Story 4.3 (Money Flow Column): Basic money flow display exists but calculations may be incorrect based on current issues identified.

## Change Log

| Date       | Version | Description                                                   | Author             |
| ---------- | ------- | ------------------------------------------------------------- | ------------------ |
| 2025-08-18 | 1.0     | Initial story creation for accurate money flow implementation | Bob (Scrum Master) |
| 2025-08-21 | 1.1     | Updated status with live testing findings - critical issues discovered with real-time data connection and dummy data display | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References

_To be populated by development agent_

### Completion Notes List

_To be populated by development agent_

### File List

_To be populated by development agent_

## QA Results

_To be populated by QA Agent_
