# Story 4.7: Enhance Race Interface UI Architecture and Design

**Status**: Approved

**As a** user viewing detailed race information  
**I want** an enhanced race display interface with money flow visualization, horizontal scrolling time columns, and professional betting terminal layout  
**So that** I can analyze real-time market movements and make informed decisions with comprehensive visual data density.

## Acceptance Criteria

1. Enhanced race header displays navigation, timing, and contextual status information. [Source: docs/front-end-spec-race-display-update.md#L25-L33]
2. Money flow timeline grid displays horizontal scrolling time columns (T-60m to Start) with incremental money flow visualization. [Source: docs/front-end-spec-race-display-update.md#L36-L55] 
3. Professional data density layout maximizes information display while maintaining scan-ability and real-time performance. [Source: docs/front-end-spec-race-display-update.md#L14-L21]
4. Interactive sorting and pool toggle functionality (Win/Place/Odds views) with keyboard navigation support. [Source: docs/front-end-spec-race-display-update.md#L91-L103]
5. Enhanced accessibility features including screen reader support for live data updates and comprehensive ARIA labeling. [Source: docs/front-end-spec-race-display-update.md#L139-L159]
6. Performance targets achieved: <200ms first paint, <100ms real-time updates, <300ms race switching. [Source: docs/front-end-spec-race-display-update.md#L75-L79]

## Story Context

This story implements **Sally's comprehensive UI/UX specification v4.7** for an enhanced race display interface that transforms the existing race view into a professional betting terminal layout optimized for real-time market analysis. The enhancement focuses on **data density maximization** while maintaining performance and accessibility standards.

**Key Enhancement Objectives:**
- **Professional Interface Design**: Transform to betting terminal-style layout with comprehensive data visualization
- **Money Flow Timeline**: Horizontal scrolling time columns showing incremental money flow from T-60m to race start
- **Enhanced Data Density**: Maximize information display with optimized layout and visual hierarchy
- **Real-Time Performance**: Maintain sub-100ms update latency with enhanced visual feedback
- **Progressive Enhancement Strategy**: Build on existing architecture while adding advanced visualization features

## Dev Notes

### Previous Story Context

Building on the comprehensive real-time architecture established in Stories 4.1-4.6:

- **Existing Real-Time Infrastructure**: Complete WebSocket-based real-time updates with `useRealtimeEntrants` hook and batched update optimization [Source: docs/stories/4.6.implement-race-navigation-buttons.md#L31-L33]
- **Performance Foundation**: React.memo, useMemo, and component optimization already implemented for smooth operation [Source: docs/stories/4.6.implement-race-navigation-buttons.md#L34]
- **Navigation Architecture**: Race navigation with data preservation already established [Source: docs/stories/4.6.implement-race-navigation-buttons.md#L44-L54]
- **Server Component Data Fetching**: Comprehensive race data fetching with 200 money flow + 500 odds history records [Source: docs/stories/4.6.implement-race-navigation-buttons.md#L30-L31]

### v4.7 Enhanced Database Schema Requirements

**New Collections for Enhanced UI:**

- **money-flow-history Collection**: Time-series money flow data optimized for timeline visualization [Source: docs/architecture/4-database-schema-appwrite.md#L24-L27]
  - Fields: `winPoolAmount`, `placePoolAmount`, `totalPoolAmount`, `poolPercentage`, `incrementalAmount`, `pollingTimestamp`, `timeToStart`, `pollingInterval`
  - Indexes: `idx_polling_timestamp`, `idx_entrant_polling` (compound), `idx_time_to_start` for efficient time-series queries
- **race-pools Collection**: Race-level pool totals for enhanced footer display [Source: docs/architecture/4-database-schema-appwrite.md#L29-L31] 
  - Fields: `winPoolTotal`, `placePoolTotal`, `quinellaPoolTotal`, `trifectaPoolTotal`, `lastUpdated`
  - Index: `idx_race_id` (unique), `idx_last_updated`
- **jockey-silks Collection**: Jockey silk visual data for enhanced runner display [Source: docs/architecture/4-database-schema-appwrite.md#L33-L35]
  - Fields: `silkId`, `primaryColor`, `secondaryColor`, `pattern`, `iconUrl`, `jockeyName`
  - Indexes: `idx_silk_id` (unique), `idx_jockey_name`

### Enhanced Component Architecture Requirements

**New Component Structure for v4.7:** [Source: docs/architecture/3-frontend-architecture-nextjs-15.md#L26-L62]

- **EnhancedEntrantsGrid.tsx**: Primary virtualized data grid with money flow timeline visualization
- **MoneyFlowColumns.tsx**: Horizontal scrolling time period columns (T-60m to Start) with incremental money display
- **PoolToggle.tsx**: Win/Place/Odds view switcher with keyboard navigation support
- **JockeySilks.tsx**: Color-coded silk display components for visual runner identification
- **SortableColumns.tsx**: Interactive column sorting with visual indicators and keyboard support
- **RaceFooter.tsx**: Enhanced footer with pool totals, race results, and comprehensive status display

### Data Fetching Strategy Enhancement

**Server-Side Rendering (SSR) Strategy:** [Source: docs/architecture/3-frontend-architecture-nextjs-15.md#L66-L87]

Enhanced parallel data fetching for first paint performance:
```typescript
// Enhanced Promise.all() pattern for v4.7 data requirements
const [raceData, entrants, moneyFlowHistory, racePools, jockeySilks] = await Promise.all([
  // Existing race and entrant data
  databases.getDocument('raceday-db', 'races', raceId),
  databases.listDocuments('raceday-db', 'entrants', [Query.equal('race', raceId)]),
  // New v4.7 enhanced data
  databases.listDocuments('raceday-db', 'money-flow-history', [
    Query.equal('entrant.race', raceId),
    Query.greaterThanEqual('pollingTimestamp', T_minus_60m),
    Query.orderAsc('pollingTimestamp')
  ]),
  databases.getDocument('raceday-db', 'race-pools', raceId),
  databases.listDocuments('raceday-db', 'jockey-silks', [Query.equal('jockeyName', entrantJockeys)])
]);
```

**Client-Side Real-Time Enhancement:** [Source: docs/architecture/3-frontend-architecture-nextjs-15.md#L90-L100]

Enhanced subscription architecture for v4.7 collections:
```typescript
// Enhanced real-time subscriptions for new data types
const subscriptions = [
  // Existing entrant subscriptions continue
  supabase.channel(`race:${raceId}:entrants`),
  // New v4.7 subscriptions
  supabase.channel(`race:${raceId}:money-flow-history`),
  supabase.channel(`race:${raceId}:race-pools`),
];
```

### Money Flow Timeline Visualization Requirements

**Time Column Implementation Strategy:** [Source: docs/front-end-spec-race-display-update.md#L82-L89]

- **Polling Window Alignment**: T-60m, T-40m, T-20m, T-10m, T-5m, T-2m, T-1m, Start columns based on actual data polling frequency
- **Horizontal Scrolling**: Implement when columns exceed viewport width with sticky runner name column
- **Incremental Display**: Show money flow changes since previous polling period, not cumulative totals
- **Visual Indicators**: Lightning bolt (âš¡) for recent changes, color coding for significant movement patterns
- **Performance Optimization**: Virtualized scrolling for large datasets, optimized re-rendering with React.memo

### Enhanced Visual Design Implementation

**Color System for Money Flow:** [Source: docs/front-end-spec-race-display-update.md#L114-L121]

- **Green (ðŸŸ¢)**: Significant positive money flow increase
- **Yellow (ðŸŸ¡)**: Moderate money flow change  
- **Red (ðŸ”´)**: Unusual money flow pattern (high odds with large increase)
- **Lightning (âš¡)**: Recent change in last update cycle

**Typography and Layout Optimization:** [Source: docs/front-end-spec-race-display-update.md#L128-L137]

- **Monospace fonts**: All numerical data (odds, money, percentages) for consistent alignment
- **Condensed font variant**: Runner names to maximize horizontal space utilization
- **Reduced padding**: Data cells while maintaining WCAG 2.1 accessibility compliance
- **Sticky headers**: For long runner lists with horizontal scrolling support

### Performance Requirements and Optimization

**Performance Targets for v4.7:** [Source: docs/front-end-spec-race-display-update.md#L75-L79]

- **First Paint**: <200ms for cached race data with SSR
- **Real-time Update Latency**: <100ms for WebSocket updates
- **Race Switching**: <300ms total transition time with client-side navigation
- **Memory Management**: Efficient virtualization for large datasets

**Optimization Strategies:** [Source: docs/architecture/8-coding-standards.md#L97-L105]

- **React.memo()**: All enhanced components wrapped for optimized re-rendering
- **useMemo()**: Heavy calculations for money flow processing and column generation
- **useCallback()**: Event handlers and sorting functions
- **Bundle Splitting**: Dynamic imports for heavy visualization components

### Accessibility Enhancement Requirements

**Screen Reader Support for Real-Time Data:** [Source: docs/front-end-spec-race-display-update.md#L141-L148]

- **Live Regions**: ARIA live announcements for significant odds changes and money flow alerts
- **Data Table Accessibility**: Comprehensive column headers with sort state and row headers for runner identification
- **ARIA Labels**: Complex data relationships and time-based visualizations

**Keyboard Navigation Enhancement:** [Source: docs/front-end-spec-race-display-update.md#L104-L111]

- **Arrow Keys**: Navigate between runners and time columns
- **Tab**: Move between interface sections (header, grid, footer)
- **Space**: Toggle pool view (Win/Place/Odds)
- **R**: Refresh data manually
- **S**: Cycle through sortable columns

### Integration with Existing Architecture

**Backward Compatibility Strategy:** [Source: docs/architecture/8-migration-to-v47-enhanced-race-interface.md#L23-L28]

- **Progressive Enhancement**: Existing race pages continue working during migration
- **Feature Flags**: A/B testing capability for enhanced vs existing grid
- **Data Preservation**: All existing collections and APIs remain unchanged
- **Performance Monitoring**: Real-time metrics during enhanced interface rollout

### File Locations and Component Organization

**Enhanced Component Structure:** [Source: docs/architecture/7-source-tree.md#L22-L27]

- **Server Component**: Enhance existing `/src/app/race/[id]/page.tsx` with new data fetching requirements
- **Enhanced Grid**: New `/src/components/race-view/EnhancedEntrantsGrid.tsx` with virtualization
- **Money Flow Columns**: New `/src/components/race-view/MoneyFlowColumns.tsx` for timeline visualization
- **Pool Toggle**: New `/src/components/race-view/PoolToggle.tsx` for view switching
- **Jockey Silks**: New `/src/components/race-view/JockeySilks.tsx` for visual identification
- **Enhanced Footer**: New `/src/components/race-view/RaceFooter.tsx` with pool totals

**Type Definitions Enhancement:** [Source: docs/architecture/3-frontend-architecture-nextjs-15.md#L57-L61]

- **Money Flow Types**: `/src/types/moneyFlow.ts` for timeline data structures
- **Race Pools Types**: `/src/types/racePools.ts` for pool totals interfaces
- **Jockey Silks Types**: `/src/types/jockeySilks.ts` for silk visual data

### Testing Requirements for Enhanced Interface

**Component Testing Strategy:** [Source: docs/architecture/8-coding-standards.md#L206-L224]

- **Enhanced Grid Testing**: Virtualization performance, sorting functionality, horizontal scrolling
- **Money Flow Visualization**: Time column accuracy, incremental calculations, visual indicators
- **Real-Time Updates**: Subscription continuity during interface enhancement, data preservation
- **Accessibility Testing**: Screen reader compatibility, keyboard navigation, ARIA live regions
- **Performance Testing**: First paint timing, update latency, race switching speed

**Integration Testing Requirements:**

- **Cross-Component Integration**: Header navigation with enhanced grid state
- **Real-Time Data Flow**: End-to-end testing of WebSocket updates through enhanced visualization
- **Progressive Enhancement**: Fallback functionality when enhanced features fail to load
- **Multi-Race Navigation**: Enhanced interface state preservation during race switching

## Tasks / Subtasks

- [ ] T1: Implement enhanced database schema and data migration (AC: 1,2,3)
  - [ ] ST1.1: Deploy new collections: `money-flow-history`, `race-pools`, `jockey-silks` with optimized indexes
  - [ ] ST1.2: Update existing `race-data-poller` function to populate new money flow history data
  - [ ] ST1.3: Implement `money-flow-tracker` event-triggered function for real-time money flow capture
  - [ ] ST1.4: Implement `race-pools-aggregator` function for pool totals maintenance
  - [ ] ST1.5: Implement `jockey-silks-enricher` HTTP-triggered function for silk data population
  - [ ] ST1.6: Create database migration script for historical data conversion

- [x] T2: Create enhanced type definitions and interfaces (AC: 1,2,3,4)
  - [x] ST2.1: Create `/src/types/moneyFlow.ts` with money flow timeline data structures
  - [x] ST2.2: Create `/src/types/racePools.ts` with pool totals and race results interfaces
  - [x] ST2.3: Create `/src/types/jockeySilks.ts` with silk color and pattern data structures
  - [x] ST2.4: Extend existing race data types to include enhanced v4.7 data
  - [x] ST2.5: Create enhanced grid state management interfaces for sorting and pool toggle

- [ ] T3: Implement enhanced server-side data fetching (AC: 1,2,6)
  - [ ] ST3.1: Enhance `/src/app/race/[id]/page.tsx` with parallel fetching for new v4.7 collections
  - [ ] ST3.2: Implement optimized queries for money flow history with time-series filters
  - [ ] ST3.3: Add race pools and jockey silks data to existing Promise.all() pattern
  - [ ] ST3.4: Optimize query performance with compound indexes and time-based filtering
  - [ ] ST3.5: Implement error handling and fallback strategies for new data sources

- [x] T4: Create MoneyFlowColumns component with horizontal scrolling (AC: 2,4,6)
  - [x] ST4.1: Create `/src/components/race-view/MoneyFlowColumns.tsx` with virtualized horizontal scrolling
  - [x] ST4.2: Implement time column generation (T-60m to Start) based on polling intervals
  - [x] ST4.3: Add incremental money flow calculation and display logic
  - [x] ST4.4: Implement visual indicators (âš¡ lightning, color coding) for money flow changes
  - [x] ST4.5: Add sticky header and runner name column for horizontal scroll navigation
  - [x] ST4.6: Optimize performance with React.memo, useMemo for column generation

- [x] T5: Create enhanced EnhancedEntrantsGrid component (AC: 2,3,4,6)
  - [x] ST5.1: Create `/src/components/race-view/EnhancedEntrantsGrid.tsx` with professional layout
  - [x] ST5.2: Integrate MoneyFlowColumns component with main entrants data
  - [x] ST5.3: Implement virtualization for large datasets and smooth scrolling performance
  - [x] ST5.4: Add enhanced runner information display with jockey silks integration
  - [x] ST5.5: Implement responsive design with mobile-first approach and container queries
  - [x] ST5.6: Add sortable column headers with visual indicators and keyboard support

- [x] T6: Implement PoolToggle and SortableColumns functionality (AC: 4,5)
  - [x] ST6.1: Create `/src/components/race-view/PoolToggle.tsx` for Win/Place/Odds view switching
  - [x] ST6.2: Create `/src/components/race-view/SortableColumns.tsx` with interactive sorting
  - [x] ST6.3: Implement keyboard navigation support (Space, Arrow keys, Tab)
  - [x] ST6.4: Add sort state persistence per session with local storage
  - [x] ST6.5: Implement ARIA labels and accessibility features for interactive elements
  - [x] ST6.6: Add visual feedback for user interactions and state changes

- [x] T7: Create JockeySilks and enhanced visual components (AC: 2,3)
  - [x] ST7.1: Create `/src/components/race-view/JockeySilks.tsx` for color-coded silk display
  - [x] ST7.2: Implement silk pattern rendering with CSS and SVG graphics
  - [x] ST7.3: Add fallback handling for missing or incomplete silk data
  - [x] ST7.4: Implement efficient caching strategy for silk images and patterns
  - [x] ST7.5: Add high contrast and accessibility-compliant color alternatives

- [x] T8: Enhance RaceHeader and create RaceFooter components (AC: 1,3)
  - [ ] ST8.1: Enhance existing `/src/components/race-view/RaceHeader.tsx` with professional layout
  - [ ] ST8.2: Add pool totals, timing information, and WebSocket connection status display
  - [x] ST8.3: Create new `/src/components/race-view/RaceFooter.tsx` with comprehensive race status
  - [x] ST8.4: Implement race results display and pool breakdown information
  - [x] ST8.5: Add responsive design for various screen sizes and orientations

- [ ] T9: Implement enhanced real-time subscriptions and state management (AC: 2,6)
  - [ ] ST9.1: Enhance existing real-time hooks for new v4.7 collections
  - [ ] ST9.2: Create `/src/hooks/useMoneyFlowData.ts` for money flow timeline state management
  - [ ] ST9.3: Create `/src/hooks/useGridSorting.ts` for sorting state and interactions
  - [ ] ST9.4: Create `/src/hooks/usePoolToggle.ts` for pool view switching state
  - [ ] ST9.5: Implement batched updates and optimization for enhanced real-time performance
  - [ ] ST9.6: Add error handling and reconnection logic for WebSocket interruptions

- [ ] T10: Implement comprehensive accessibility features (AC: 5)
  - [ ] ST10.1: Add ARIA live regions for real-time money flow and odds change announcements
  - [ ] ST10.2: Implement comprehensive ARIA labels for complex data relationships and time-based data
  - [ ] ST10.3: Add keyboard navigation support for all interactive elements
  - [ ] ST10.4: Implement screen reader-friendly descriptions for visual money flow indicators
  - [ ] ST10.5: Add high contrast mode support and color-independent change indicators
  - [ ] ST10.6: Test with screen readers (NVDA, JAWS, VoiceOver) and keyboard-only navigation

- [ ] T11: Performance optimization and testing (AC: 6)
  - [ ] ST11.1: Implement comprehensive React.memo, useMemo, useCallback optimizations
  - [ ] ST11.2: Add bundle splitting and dynamic imports for heavy visualization components
  - [ ] ST11.3: Implement memory management and cleanup for virtualized components
  - [ ] ST11.4: Add performance monitoring and metrics collection for real-time features
  - [ ] ST11.5: Optimize database queries and implement efficient caching strategies
  - [ ] ST11.6: Test and validate performance targets: <200ms first paint, <100ms updates, <300ms switching

- [ ] T12: Integration testing and progressive enhancement (AC: 1,2,3,4,5,6)
  - [ ] ST12.1: Implement feature flags for A/B testing enhanced vs existing interface
  - [ ] ST12.2: Test backward compatibility and graceful degradation scenarios
  - [ ] ST12.3: Validate enhanced interface works with existing navigation and real-time architecture
  - [ ] ST12.4: Test cross-browser compatibility and responsive design across devices
  - [ ] ST12.5: Implement comprehensive unit and integration tests for all enhanced components
  - [ ] ST12.6: Test real-world scenarios with live race data and WebSocket connections

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-13 | 1.0 | Initial draft created with comprehensive architecture integration for v4.7 enhanced race interface implementation. Includes detailed component specifications, database schema requirements, accessibility features, and performance optimization strategies based on Sally's UI specification and Winston's architectural updates. | Bob (Scrum Master) |