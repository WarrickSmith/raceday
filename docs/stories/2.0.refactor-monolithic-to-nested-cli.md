# Story 2.0: Refactor existing monolithic function to nested Appwrite CLI structure

## Status
Draft

## Story
**As a** developer  
**I need** to refactor the existing monolithic `daily-race-importer` work into the new nested Appwrite CLI structure  
**So that** existing progress is preserved while transitioning to the microservices architecture.

## Acceptance Criteria
1. [ ] Existing monolithic function work is successfully migrated to nested structure.
2. [ ] Shared utilities are created for API calls, data parsing, and database operations.
3. [ ] Base nested CLI structure is ready for individual function implementations.
4. [ ] No functional regression from existing working components.
5. [ ] Deployment configuration supports individual function deployment.
6. [ ] All existing timeout protection and error handling is preserved.
7. [ ] Foundation is ready for Stories 2.1 and 2.2 implementation.

## Tasks / Subtasks
- [ ] Review existing monolithic `daily-race-importer` implementation (AC: 1, 4)
  - [ ] Analyze current main.js functionality and identify reusable components
  - [ ] Document existing TAB API integration patterns
  - [ ] Document existing database operations and error handling
- [ ] Create base nested Appwrite CLI structure (AC: 3, 5)
  - [ ] Set up server/ directory with nested function structure  
  - [ ] Create shared utilities directory for common code
  - [ ] Create server-level package.json with npm deployment scripts for individual functions
  - [ ] Update appwrite.json configuration for individual function deployment
  - [ ] Migrate existing deployment scripts to support new nested structure
- [ ] Extract and replicate utilities across function directories (AC: 2, 6)
  - [ ] Extract TAB API client functions into each function's src/api-client.js
  - [ ] Extract database operations into each function's src/database-utils.js
  - [ ] Extract database setup logic into daily-meetings/src/database-setup.js (from existing database-setup.js)
  - [ ] Extract data parsing and filtering logic into each function's src/data-processors.js
  - [ ] Preserve all existing timeout protection (15-second API timeouts)
  - [ ] Preserve all existing error handling patterns
  - [ ] Ensure shared .env file access across all functions (similar to current implementation)
  - [ ] Update TAB API client to use proper headers from environment variables
- [ ] Migrate existing functionality while preserving behavior (AC: 1, 4, 6)
  - [ ] Test that API calls work identically to existing implementation
  - [ ] Test that database operations maintain same upsert patterns
  - [ ] Verify error isolation and timeout protection is maintained
- [ ] Prepare foundation for microservices implementation (AC: 7)
  - [ ] Structure shared utilities to support daily-meetings function
  - [ ] Structure shared utilities to support daily-races function  
  - [ ] Structure shared utilities to support daily-entrants function
  - [ ] Structure shared utilities to support race-data-poller function
  - [ ] Ensure daily-meetings function includes database setup responsibility (first scheduled task)

## Dev Notes

### Previous Story Insights
This is the first story in Epic 2, so no previous story context is available.

### Current Monolithic Implementation Analysis
**Location**: `/server/appwrite/functions/daily-race-importer/`
- **Main Function**: 490 lines implementing complete data pipeline
- **Database Setup**: 586 lines handling all collection management
- **Current Schedule**: 17:00 UTC daily execution
- **Resource Specification**: Standard Appwrite function limits

**Existing TAB API Integration** [Source: architecture/3-backend-services-appwrite-functions.md#existing-implementation]:
- Meetings API fetch with AU/NZ country filtering  
- Race Events API with comprehensive entrant data
- 15-second timeout protection on all external API calls
- Proper affiliate credential handling via environment variables
- Rate limiting protection with 1-second delays between races

**Existing Database Operations** [Source: architecture/3-backend-services-appwrite-functions.md#database-operations]:
- Performant upsert pattern (update-first, create-on-404)
- Batch processing in 15-race batches to prevent timeouts
- Comprehensive error isolation - individual failures don't stop entire pipeline
- Relationship management between meetings, races, and entrants collections

**Existing Database Setup Logic** [Source: server/appwrite/functions/daily-race-importer/src/main.js]:
- Database setup called via `ensureDatabaseSetup()` function at start of daily-race-importer
- 60-second timeout protection for database setup operations
- Setup failure doesn't prevent rest of function from continuing
- Complete database schema creation (586 lines in existing database-setup.js)
- All collections and attributes created: meetings, races, entrants, odds-history, money-flow-history, user-alert-configs, notifications

### Target Nested CLI Structure
**Required Directory Structure** [Source: Appwrite deployment constraints and current implementation]:
```
server/
├── package.json               # Server-level deployment and execution scripts
├── scripts/                   # Deployment and local execution utilities (migrated from current)
│   ├── run-function.js        # Local function execution with mock context
│   ├── execute-function.js    # Remote function execution helper
│   ├── deploy.js              # Individual function deployment
│   └── login.js               # Appwrite CLI authentication
├── .env                       # Shared environment variables
├── .env.example              # Environment variables template
├── daily-meetings/
│   ├── src/
│   │   ├── main.js            # Function entry point
│   │   ├── api-client.js      # TAB API integration functions  
│   │   ├── database-utils.js  # Database operations and upsert logic
│   │   ├── database-setup.js  # Database schema setup and collection management
│   │   ├── data-processors.js # Data parsing and filtering logic
│   │   └── error-handlers.js  # Common error handling patterns
│   ├── package.json
│   └── appwrite.json
├── daily-races/
│   ├── src/
│   │   ├── main.js            # Function entry point
│   │   ├── api-client.js      # TAB API integration functions
│   │   ├── database-utils.js  # Database operations and upsert logic
│   │   ├── data-processors.js # Data parsing and filtering logic
│   │   └── error-handlers.js  # Common error handling patterns
│   ├── package.json
│   └── appwrite.json
├── daily-entrants/
│   ├── src/
│   │   ├── main.js            # Function entry point  
│   │   ├── api-client.js      # TAB API integration functions
│   │   ├── database-utils.js  # Database operations and upsert logic
│   │   ├── data-processors.js # Data parsing and filtering logic
│   │   └── error-handlers.js  # Common error handling patterns
│   ├── package.json
│   └── appwrite.json
└── race-data-poller/
    ├── src/
    │   ├── main.js            # Function entry point
    │   ├── api-client.js      # TAB API integration functions
    │   ├── database-utils.js  # Database operations and upsert logic
    │   ├── data-processors.js # Data parsing and filtering logic
    │   └── error-handlers.js  # Common error handling patterns
    ├── package.json
    └── appwrite.json
```

**Deployment and Execution Strategy** [Source: current server/appwrite implementation]:
- Each function is self-contained with all required utilities in its `src/` directory
- No shared directory needed since utilities are specific to each function
- Local execution uses scripts/run-function.js with mock Appwrite context
- Remote execution uses Appwrite CLI commands

**Server-Level Package.json Scripts** [Source: current server/appwrite/package.json pattern]:
- `npm run deploy:meetings` - Deploy daily-meetings function
- `npm run deploy:races` - Deploy daily-races function  
- `npm run deploy:entrants` - Deploy daily-entrants function
- `npm run deploy:poller` - Deploy race-data-poller function
- `npm run deploy` - Deploy all functions
- `npm run meetings` - Run daily-meetings function locally with mock context
- `npm run races` - Run daily-races function locally with mock context
- `npm run entrants` - Run daily-entrants function locally with mock context
- `npm run poller` - Run race-data-poller function locally with mock context
- `npm run execute` - Show available functions and execution options
- `npm run vars:all` - Update environment variables for all functions

**Database Setup Responsibility**:
- **daily-meetings function** (first scheduled at 17:00 UTC) performs database setup check
- Uses shared `database-setup.js` to ensure all collections and attributes exist
- Creates complete database schema for all functions (meetings, races, entrants, odds-history, money-flow-history, user-alert-configs, notifications)
- 60-second timeout protection with graceful failure handling
- Setup failure doesn't prevent meetings processing from continuing

### Database Schema Requirements  
**Collections** [Source: architecture/2-appwrite-database-schema.md]:
- **meetings**: Race meeting information with date, country, raceType indexes
- **races**: Individual race details linked to meetings  
- **entrants**: Horse entrants linked to races
- **odds-history**: Historical odds data for entrants
- **money-flow-history**: Money flow tracking for entrants
- **user-alert-configs**: User notification preferences
- **notifications**: Real-time alert notifications

**Relationship Requirements**:
- races → meetings (many-to-one relationship)
- entrants → races (many-to-one relationship)
- odds-history → entrants (many-to-one relationship)
- money-flow-history → entrants (many-to-one relationship)

### API Specifications
**NZ TAB API Endpoints** [Source: architecture/9-dependencies.md]:
- Meetings API: Daily race meetings with country filtering
- Race Events API: Detailed race and entrant data with `with_tote_trends_data=true`
- **No Authentication Required**: Uses HTTP headers for identification (not authentication)
- **Required Headers**: 
  - `From: ws@baybox.co.nz`
  - `X-Partner: Warrick Smith`
  - `X-Partner-ID: Private-Developer`
- **Rate Limiting**: 15-second timeouts, 1-second delays between requests

### Technical Constraints
**Language Requirements** [Source: architecture/8-coding-standards.md#backend]:
- JavaScript exclusively for all Appwrite functions (no TypeScript compilation)
- Node.js v22.17.0+ runtime
- Appwrite Node.js SDK v17.0.0+

**Error Handling Requirements** [Source: architecture/8-coding-standards.md#backend]:
- All functions must include robust error handling and logging
- Environment variables for configuration (shared across functions like current implementation)
- Idempotent operations where possible

**Environment Variables Required** [Source: server/appwrite/.env.example]:
- `APPWRITE_ENDPOINT`: Appwrite instance URL
- `APPWRITE_PROJECT_ID`: Project identifier
- `APPWRITE_API_KEY`: API key for function runtime operations
- `NZTAB_API_BASE_URL`: Base URL for NZ TAB API
- Headers configured in code: From, X-Partner, X-Partner-ID values

**Resource Specifications** [Source: architecture/3-backend-services-appwrite-functions.md#function-specifications]:
- daily-meetings: s-1vcpu-512mb, ~60s execution
- daily-races: s-1vcpu-512mb, ~90s execution  
- daily-entrants: s-1vcpu-1gb, ~300s execution
- race-data-poller: s-2vcpu-2gb, ~120s execution

### File Locations
**Source File Structure** [Source: Appwrite deployment constraints]:
- **Function utilities**: Self-contained in each `/server/{function-name}/src/` directory
- **Deployment scripts**: In `/server/scripts/` directory for shared deployment logic
- **Import paths**: Functions use relative imports like `import { api } from './api-client.js'`
- **Appwrite path**: Each function's `appwrite.json` path points to its individual directory
- **Local execution**: Uses `scripts/run-function.js` with mock Appwrite context
- **Environment variables**: Shared `.env` file accessible to all functions and scripts

### Testing

**Testing Requirements** [Source: architecture/8-coding-standards.md]:
- **Approach**: Code migration first, basic level testing only
- **Integration Testing Priority**: Focus on actual deployment success verification
- **Shared Utilities Testing**: Test shared utilities independently from individual functions
- **API Compatibility**: Verify API calls work identically to existing implementation with proper headers
- **Database Operations**: Confirm database operations maintain same upsert patterns
- **Deployment Validation**: Integration tests should verify successful deployment of each function

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-23 | 0.1 | Initial story creation | Bob (Scrum Master) |
| 2025-01-23 | 0.2 | Updated NZ TAB API headers, environment variables, and testing approach | Bob (Scrum Master) |
| 2025-01-23 | 0.3 | Critical fix: Updated directory structure for Appwrite deployment constraints - shared utilities must be copied to individual function directories | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References  
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be added here*