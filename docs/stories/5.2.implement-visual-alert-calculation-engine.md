# Story 5.2: Implement Visual Alert Calculation Engine

**Status**: Ready for Review

## Story

**As a** developer,
**I want** to create a calculation engine for visual alert indicators,
**so that** percentage changes in money amounts and odds can be accurately computed and displayed.

## Acceptance Criteria

1. **Money Percentage Calculations:**

   - [x] Money percentage calculations use timeframe-specific totals, not cumulative pool totals
   - [x] Money indicators only show increases, never decreases

2. **Odds Calculations:**

   - [x] Odds calculations show shortening (decreases) only for Win Odds
   - [x] Calculation engine integrates with existing alert configuration from Story 5.1

3. **Threshold Integration:**
   - [x] Threshold matching correctly maps percentage changes to configured indicator ranges
   - [x] Unit tests cover both money and odds calculation scenarios

## Tasks / Subtasks

- [x] **Create Money Percentage Change Calculation Logic** (AC: 1)

  - [x] Implement `calculateMoneyChangePercentage` function that compares entrant's percentage of timeframe total vs previous timeframe
  - [x] Calculate each entrant's contribution as percentage of total money added in that specific timeframe only
  - [x] Only return positive changes (current % > previous %), ignore decreases
  - [x] Add comprehensive unit tests for various money flow scenarios

- [x] **Create Win Odds Change Calculation Logic** (AC: 2)

  - [x] Implement `calculateOddsChangePercentage` function for odds shortening detection
  - [x] Calculate percentage decrease in odds compared to previous timeframe for same entrant
  - [x] Only detect when odds shorten (decrease), indicating increased confidence
  - [x] Add unit tests covering odds movement scenarios

- [x] **Implement Indicator Threshold Matching System** (AC: 3)

  - [x] Create `mapPercentageToIndicator` function using the 6-tier system (5-10%, 10-15%, 15-20%, 20-25%, 25-50%, 50%+)
  - [x] Return corresponding indicator colors (Gray, Blue, Yellow, Green, Red, Magenta)
  - [x] Handle edge cases and invalid percentage values
  - [x] Test threshold boundary conditions

- [x] **Build Alert Configuration Integration Service** (AC: 2, 3)

  - [x] Create `alertCalculationService.ts` that reads user alert configuration from existing Story 5.1 implementation
  - [x] Integrate with existing `alertConfigService.ts` for user preference retrieval
  - [x] Apply user-enabled thresholds to filter which indicators to display
  - [x] Handle cases where user has disabled specific indicator ranges

- [x] **Create Comprehensive Test Suite** (AC: 3)
  - [x] Test money calculation scenarios matching indicator-logic.txt examples
  - [x] Test odds calculation scenarios with proper shortening detection
  - [x] Test threshold mapping accuracy across all 6 ranges
  - [x] Test integration with user alert configurations
  - [x] Test edge cases and error conditions

## Dev Notes

### Previous Story Insights

From Story 5.1: Alert configuration infrastructure is complete with `AlertsConfigModal.tsx`, `alertConfigService.ts`, and user preference storage. The 6-tier indicator system (5-10% → Gray through 50%+ → Magenta) is already established and configurable by users. This story builds the calculation foundation that will be consumed by Story 5.3.

### Data Models

**Money Flow History Access:**
[Source: architecture/4-database-schema-appwrite.md#money-flow-history]

- Access `money-flow-history` collection with fields: `entrant`, `raceId`, `holdPercentage`, `betPercentage`, `timeToStart`, `timeInterval`, `eventTimestamp`, `winPoolAmount`, `placePoolAmount`, `incrementalAmount`
- Use timeframe-specific amounts for percentage calculations, not cumulative totals
- Query by `entrant` and `timeInterval` for comparing consecutive time periods

**User Alert Configuration Integration:**
[Source: architecture/4-database-schema-appwrite.md#user-alert-configs]

- Use existing `user-alert-configs` collection with fields: `userId`, `alertType`, `threshold`, `enabled`
- Integration point with Story 5.1's `alertConfigService.ts` for user preference retrieval
- Alert configuration defines which percentage thresholds are active for each user

### Alert Calculation Logic Requirements

**Detailed Money Flow Logic:**
[Source: /home/warrick/Dev/raceday/indicator-logic.txt]

- For money amounts: Calculate each entrant's percentage of total money added in current timeframe vs previous timeframe
- Example: Entrant 4 has 40 of 280 total in T1 (14%), then 100 of 340 total in T2 (29%). Change = 29% - 14% = 15% → Blue indicator
- Only show increases in relative percentage, never decreases
- Use timeframe-specific totals, not cumulative pool amounts

**Detailed Odds Logic:**
[Source: /home/warrick/Dev/raceday/indicator-logic.txt]

- For Win Odds only: Calculate percentage decrease (shortening) from previous timeframe for same entrant
- Example: Entrant 3 odds change from 12.00 to 7.00 = (12-7)/12 = 42% decrease → Red indicator
- Only interested in odds shortening (decreases) as this indicates money flow and increased confidence
- Compare current timeframe odds vs previous timeframe odds for same entrant

**6-Tier Threshold System:**

- 5-10% → Gray
- 10-15% → Blue
- 15-20% → Yellow
- 20-25% → Green
- 25-50% → Red
- 50%+ → Magenta

### Component Specifications

**Service Architecture:**
[Source: architecture/3-frontend-architecture-nextjs-15.md#enhanced-component-architecture]

- Create calculation services in `src/services/` directory following existing patterns
- Use TypeScript interfaces for type safety and clear contracts
- Implement proper error handling and edge case management
- Follow existing service patterns from `alertConfigService.ts`

**Calculation Engine Structure:**
[Source: architecture/6-tech-stack.md#615-state-management]

- Pure functions for calculation logic to enable easy testing and reuse
- Clear separation between calculation logic and user preference integration
- Comprehensive TypeScript type definitions for calculation inputs/outputs
- Efficient algorithms suitable for real-time updates

### File Locations

**Service Files:**
[Source: architecture/7-source-tree.md]

- **Calculation Engine:** `src/services/alertCalculationService.ts`
- **Type Definitions:** `src/types/alertCalculations.ts`
- **Test Files:** `src/services/__tests__/alertCalculationService.test.ts`

**Integration Points:**

- Integrate with existing `src/services/alertConfigService.ts` from Story 5.1
- Use existing `src/types/alerts.ts` for alert configuration types
- Follow patterns from `src/types/moneyFlow.ts` for money flow data structures

### Testing Requirements

**Test Framework:**
[Source: architecture/6-tech-stack.md#615-state-management]

Based on existing project patterns, use Jest and React Testing Library. Follow existing test patterns in `src/services/__tests__/` directory.

**Test Scenarios:**

**Money Flow Testing:**

- Test scenario from indicator-logic.txt: 4 entrants across 3 timeframes with specific money amounts
- Verify T2 calculation for Entrant 4: 40/280 (14%) vs 100/340 (29%) = 15% → Blue
- Test edge cases: zero amounts, single entrant, equal percentages
- Test that decreases are ignored (no negative indicators)

**Odds Movement Testing:**

- Test scenario from indicator-logic.txt: Entrant 3 odds 12.00 to 7.00 = 42% decrease → Red
- Test odds increases (lengthening) are ignored
- Test edge cases: zero odds, same odds, extreme odds changes
- Test boundary conditions at threshold levels

**Integration Testing:**

- Test with various user alert configurations (some thresholds disabled)
- Test with missing user preferences (defaults)
- Test calculation performance with large datasets
- Test error handling for malformed data

### Technical Constraints

**Performance Requirements:**
[Source: architecture/6-tech-stack.md#64-performance-targets]

- Calculation functions must execute within <100ms for real-time grid updates
- Memory-efficient algorithms for processing multiple entrants and time periods
- Optimized for frequent recalculation as real-time data arrives

**Data Quality Requirements:**

- Handle missing or null data gracefully without breaking calculations
- Validate input data ranges and provide meaningful error messages
- Ensure mathematical accuracy with proper number precision handling

### Project Structure Notes

No structural conflicts identified. Alert calculation services align with existing `src/services/` directory structure. Integration with existing Story 5.1 alert configuration follows established service communication patterns.

## Dev Agent Record

**Agent Model Used**: Claude Sonnet 4

### Tasks / Subtasks Status

- [x] **Create Money Percentage Change Calculation Logic** (AC: 1)

  - [x] Implement `calculateMoneyChangePercentage` function that compares entrant's percentage of timeframe total vs previous timeframe
  - [x] Calculate each entrant's contribution as percentage of total money added in that specific timeframe only
  - [x] Only return positive changes (current % > previous %), ignore decreases
  - [x] Add comprehensive unit tests for various money flow scenarios

- [x] **Create Win Odds Change Calculation Logic** (AC: 2)

  - [x] Implement `calculateOddsChangePercentage` function for odds shortening detection
  - [x] Calculate percentage decrease in odds compared to previous timeframe for same entrant
  - [x] Only detect when odds shorten (decrease), indicating increased confidence
  - [x] Add unit tests covering odds movement scenarios

- [x] **Implement Indicator Threshold Mapping System** (AC: 3)

  - [x] Create `mapPercentageToIndicator` function using the 6-tier system (5-10%, 10-15%, 15-20%, 20-25%, 25-50%, 50%+)
  - [x] Return corresponding indicator colors (Gray, Blue, Yellow, Green, Red, Magenta)
  - [x] Handle edge cases and invalid percentage values
  - [x] Test threshold boundary conditions

- [x] **Build Alert Configuration Integration Service** (AC: 2, 3)

  - [x] Create `alertCalculationService.ts` that reads user alert configuration from existing Story 5.1 implementation
  - [x] Integrate with existing `alertConfigService.ts` for user preference retrieval
  - [x] Apply user-enabled thresholds to filter which indicators to display
  - [x] Handle cases where user has disabled specific indicator ranges

- [x] **Create Comprehensive Test Suite** (AC: 3)
  - [x] Test money calculation scenarios matching indicator-logic.txt examples
  - [x] Test odds calculation scenarios with proper shortening detection
  - [x] Test threshold mapping accuracy across all 6 ranges
  - [x] Test integration with user alert configurations
  - [x] Test edge cases and error conditions

### Debug Log References

No issues encountered during implementation. All tests passing.

### Completion Notes

- **Money Flow Logic**: Implemented exactly per indicator-logic.txt specifications. T2 example (Entrant 4: 40/280 → 100/340 = 15% change) validates correctly.
- **Odds Logic**: Correctly calculates odds shortening (12.00 → 7.00 = 42% decrease → Red indicator).
- **Threshold Mapping**: All 6 ranges working with proper boundary conditions.
- **Integration**: Seamless integration with existing alertConfigService from Story 5.1.
- **Performance**: Pure functions optimized for <100ms execution suitable for real-time updates.
- **Test Coverage**: 27/27 tests passing with comprehensive scenarios including edge cases.

### File List

**New Files Created:**
- `src/types/alertCalculations.ts` - Type definitions for calculation engine
- `src/services/alertCalculationService.ts` - Core calculation service with all required functions
- `src/services/__tests__/alertCalculationService.test.ts` - Comprehensive test suite

**Integration Points:**
- Uses existing `src/services/alertConfigService.ts` from Story 5.1
- Uses existing `src/types/alerts.ts` for alert configuration types
- Uses existing `src/types/moneyFlow.ts` for money flow data structures

### Change Log (Dev Agent)

| Date       | Version | Description                                                   | Author        |
| ---------- | ------- | ------------------------------------------------------------- | ------------- |
| 2025-09-17 | 1.1     | Complete implementation with all tasks and tests passing     | James (Dev)   |

## Change Log

| Date       | Version | Description                                         | Author             |
| ---------- | ------- | --------------------------------------------------- | ------------------ |
| 2025-09-17 | 1.0     | Initial story creation for Alert Calculation Engine | Bob (Scrum Master) |
