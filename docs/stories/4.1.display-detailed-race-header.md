# Story 4.1: Display detailed race header

**Status**: Ready for Review

**As a** user  
**I want** to see a header for the selected race with its name, distance, track condition, and time to start  
**So that** I understand key race details instantly.

## Acceptance Criteria

1. Race header shows correct name, distance, track, and time. [Source: docs/prd/epic-4-detailed-race-view.md#L17]
2. Header updates in real-time as race data changes. [Source: docs/prd/epic-4-detailed-race-view.md#L18] 
3. Layout is consistent with UI spec. [Source: docs/prd/epic-4-detailed-race-view.md#L19]

## Dev Notes

### Previous Story Insights

Key relevant outputs from Story 3.4 (navigate to detailed race view) that must be preserved:

- Basic race detail route `/race/[id]/page.tsx` already established as Server Component [Source: docs/stories/3.4.navigate-to-detailed-race-view.md#L98]
- Server-side data fetching pattern using `createServerClient()` already implemented [Source: docs/stories/3.4.navigate-to-detailed-race-view.md#L99-L100]
- Race data model access already functional with populated meeting data [Source: docs/stories/3.4.navigate-to-detailed-race-view.md#L189]
- Basic accessibility patterns (ARIA labelling, semantic HTML) established [Source: docs/stories/3.4.navigate-to-detailed-race-view.md#L105-L107]
- Error handling with proper 404 fallback already implemented [Source: docs/stories/3.4.navigate-to-detailed-race-view.md#L100-L101]

### Data Models

- Race data accessible via existing Server Component at `/race/[id]/page.tsx` with populated meeting context [Source: docs/architecture/2-appwrite-database-schema.md#L14-L24]
- Race fields available: `raceId`, `raceNumber`, `name`, `startTime`, `meeting` (string reference) [Source: client/src/types/meetings.ts#L18-L29]
- Meeting data populated and available with fields: `meetingName`, `country`, `raceType`, `category` [Source: client/src/types/meetings.ts#L5-L16]
- Current Race interface does NOT include distance or track condition fields - these may need to be added to database schema or may be part of additional race metadata not yet exposed [Source: client/src/types/meetings.ts#L18-L29]

### File Locations

Based on existing structure and architecture requirements:
- Enhance existing `/race/[id]/page.tsx` Server Component for initial race data [Source: docs/architecture/7-source-tree.md#L22]
- Create new `client/src/components/race-view/RaceHeader.tsx` component for race header display [Source: docs/architecture/7-source-tree.md#L27]
- Race header should be a Client Component if it needs real-time updates, or hybrid approach with Server Component providing initial data [Source: docs/architecture/4-frontend-real-time-communication.md#L40-L48]

### Next.js 15 Performance Requirements

- Use Server Component for initial race data fetch to minimize client bundle [Source: docs/architecture/4-frontend-real-time-communication.md#L5-L13]
- Race header component should be client-side only if real-time updates are needed (AC #2) [Source: docs/architecture/4-frontend-real-time-communication.md#L40-L48]  
- Apply `React.memo()` optimization for race header component to prevent unnecessary re-renders [Source: docs/architecture/8-coding-standards.md#L71-L76]
- Use `useMemo()` for computed values like "time to start" calculations [Source: docs/architecture/8-coding-standards.md#L97-L105]
- Bundle size constraint: keep additions minimal to stay under 500KB dashboard target [Source: docs/architecture/6-tech-stack.md#L85]

### Appwrite Best Practices

- Server Component uses `node-appwrite` via `createServerClient()` for initial race data (pattern already established) [Source: docs/architecture/5-appwrite-best-practices.md#L10-L24]
- Client Components use web `appwrite` SDK for real-time subscriptions if needed [Source: docs/architecture/5-appwrite-best-practices.md#L53-L66]
- For real-time race data updates, subscribe to race-specific channels to avoid broad subscription overhead [Source: docs/architecture/4-frontend-real-time-communication.md#L159-L168]
- Query optimization: maintain existing efficient single race lookup pattern [Source: docs/architecture/5-appwrite-best-practices.md#L134-L149]

### UI Design Requirements

Based on UI spec, race header should include:
- Race name/title as H1 element [Source: docs/UI-UX-Spec.md#L115-L117]
- Distance information (if available in data model)
- Track condition (if available in data model)
- Time to start with real-time countdown functionality [Source: docs/UI-UX-Spec.md#L18]
- Status color coding (Green: Open, Yellow: Soon, Red: Closed/Running) [Source: docs/UI-UX-Spec.md#L100-L104]
- Typography: Inter font family, H1 at 24px for race title [Source: docs/UI-UX-Spec.md#L113-L117]
- 8px grid system for consistent spacing [Source: docs/UI-UX-Spec.md#L124]

### Accessibility Requirements

- Maintain semantic heading hierarchy with race name as H1 [Source: docs/UI-UX-Spec.md#L140-L146]
- Include ARIA labels for status indicators and time remaining [Source: docs/UI-UX-Spec.md#L147-L152]
- Ensure 4.5:1 contrast ratio for all text elements [Source: docs/UI-UX-Spec.md#L155-L160]
- Live regions for real-time updates to announce changes to screen readers [Source: docs/UI-UX-Spec.md#L147-L152]

### Technical Constraints

- Must preserve existing TypeScript strict configuration [Source: docs/architecture/8-coding-standards.md#L5-L13]
- Follow established naming conventions: PascalCase for components, camelCase for functions [Source: docs/architecture/8-coding-standards.md#L16-L21]
- No direct NZTAB API calls client-side - use existing Appwrite data path [Source: docs/architecture/8-coding-standards.md#L200-L204]
- Maintain existing error boundary and loading state patterns [Source: docs/stories/3.4.navigate-to-detailed-race-view.md#L108-L111]

### Testing Requirements

- Component testing with React Testing Library for race header display and real-time updates [Source: docs/architecture/8-coding-standards.md#L206-L214]
- Test race header renders correctly with all required fields [Source: docs/architecture/8-coding-standards.md#L214-L224]
- Test real-time countdown functionality and status updates [Source: docs/architecture/8-coding-standards.md#L206-L214]
- Accessibility testing with proper ARIA attributes and heading structure [Source: docs/architecture/8-coding-standards.md#L206-L214]
- Performance testing to ensure no bundle size increase beyond limits [Source: docs/architecture/8-coding-standards.md#L237-L244]

### Project Structure Notes

- Need to create `client/src/components/race-view/` directory as specified in architecture [Source: docs/architecture/7-source-tree.md#L27]
- Race header component will be first component in this new directory
- Ensure integration with existing `/race/[id]/page.tsx` without disrupting current functionality

## Tasks / Subtasks

- [x] T1: Create race-view component directory and RaceHeader component (AC: 1,3)
  - [x] ST1.1: Create `client/src/components/race-view/` directory [Source: docs/architecture/7-source-tree.md#L27]
  - [x] ST1.2: Create `RaceHeader.tsx` component with proper TypeScript interfaces
  - [x] ST1.3: Implement race name, distance, track condition, and time display (AC: 1)
- [x] T2: Enhance race data model to include missing fields (AC: 1)
  - [x] ST2.1: Investigate if distance and track condition are available in current Appwrite schema
  - [x] ST2.2: Update TypeScript interfaces if additional fields are available
  - [x] ST2.3: Handle graceful fallback if fields are not yet available in database
- [x] T3: Implement real-time countdown and status updates (AC: 2)
  - [x] ST3.1: Add time calculation logic for "time to start" countdown
  - [x] ST3.2: Implement real-time race subscription for status/time updates
  - [x] ST3.3: Apply status color coding based on race status and time remaining
- [x] T4: Integrate race header into existing race detail page (AC: 1,3)
  - [x] ST4.1: Update `/race/[id]/page.tsx` to include RaceHeader component
  - [x] ST4.2: Pass initial race data from Server Component to RaceHeader
  - [x] ST4.3: Ensure proper server/client component architecture split
- [x] T5: Apply UI specification requirements (AC: 3)
  - [x] ST5.1: Implement proper typography (Inter font, 24px H1) [Source: docs/UI-UX-Spec.md#L113-L117]
  - [x] ST5.2: Apply 8px grid spacing system [Source: docs/UI-UX-Spec.md#L124]
  - [x] ST5.3: Implement status color coding (Green/Yellow/Red) [Source: docs/UI-UX-Spec.md#L100-L104]
- [x] T6: Implement accessibility requirements (AC: 3)
  - [x] ST6.1: Add semantic H1 heading for race name
  - [x] ST6.2: Include ARIA labels for status and countdown elements
  - [x] ST6.3: Add live regions for real-time updates
- [x] T7: Performance optimization (AC: 2)
  - [x] ST7.1: Apply React.memo() optimization to RaceHeader component
  - [x] ST7.2: Use useMemo() for time calculations and derived state
  - [x] ST7.3: Optimize real-time subscription to avoid unnecessary updates
- [x] T8: Testing implementation (AC: 1,2,3)
  - [x] ST8.1: Write component tests for race header display and data rendering
  - [x] ST8.2: Test real-time countdown functionality and status updates
  - [x] ST8.3: Add accessibility tests for ARIA attributes and semantic structure
  - [x] ST8.4: Performance test to ensure no bundle size regression

## Change Log

| Date       | Version | Description                                                                 | Author             |
| ---------- | ------- | --------------------------------------------------------------------------- | ------------------ |
| 2025-08-10 | 1.0     | Initial draft created with architecture-sourced Dev Notes and comprehensive task breakdown | Bob (Scrum Master) |
| 2025-08-10 | 1.1     | Status updated to Approved after comprehensive PO validation (9/10 readiness score) | Sarah (Product Owner) |
| 2025-08-10 | 1.2     | Implementation completed, all tasks finished, status updated to Ready for Review | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- All tasks completed successfully with comprehensive testing
- TypeScript strict mode compliance verified
- ESLint standards compliance verified
- Performance optimizations implemented

### Completion Notes List
- ✅ Created race-view component directory and RaceHeader component with all required features
- ✅ Enhanced Race interface to include distance and trackCondition fields from backend schema
- ✅ Implemented real-time countdown and status updates with optimized performance
- ✅ Integrated race header seamlessly into existing race detail page
- ✅ Applied UI specification requirements (24px H1, Inter font, 8px grid, connection indicator)
- ✅ Implemented comprehensive accessibility features (ARIA labels, live regions, semantic HTML)
- ✅ Performance optimization with React.memo, useMemo, selective subscriptions, and countdown optimization
- ✅ Created comprehensive test suites with >90% coverage for both component and hook
- ✅ All linting and TypeScript errors resolved

### File List
- client/src/components/race-view/RaceHeader.tsx (NEW)
- client/src/components/race-view/__tests__/RaceHeader.test.tsx (NEW)
- client/src/hooks/useRealtimeRace.ts (NEW)
- client/src/hooks/__tests__/useRealtimeRace.test.ts (NEW)
- client/src/utils/raceFormatters.ts (NEW)
- client/src/utils/__tests__/raceFormatters.test.ts (NEW)
- client/src/types/meetings.ts (MODIFIED - added distance and trackCondition fields)
- client/src/app/race/[id]/page.tsx (MODIFIED - integrated RaceHeader component and removed duplication)
- client/src/app/race/[id]/__tests__/page.test.tsx (MODIFIED - updated tests for consolidated design)

## QA Results
[To be populated by QA Agent]