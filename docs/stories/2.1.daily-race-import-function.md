# Story 2.1: Create daily race import function

**Status**: Ready

**As the** system  
**I need** a serverless function that runs daily to fetch all Horse and Harness (Gallops and Trots) race meetings and races from the TAB API for Australia and New Zealand  
**So that** race data is always up to date for user filtering and display.

## Acceptance Criteria

- [ ] Function runs daily at 6:00 AM New Zealand time (17:00 UTC / 18:00 UTC during DST) to capture latest race day information
- [ ] All Horse (Thoroughbred) and Harness racing meetings and races for Australia and New Zealand are imported
- [ ] Greyhound racing is excluded from import
- [ ] Data is filtered at import time to include only AU/NZ Horse/Harness racing
- [ ] Errors are logged and surfaced

## Dev Notes

### Previous Story Insights
Story 1.3 completed the Appwrite database and collections setup with the script `/home/warrick/Dev/raceday/scripts/appwrite-setup.ts`. The database schema is already defined and collections are created. Database configuration is available at lines 17-31 of the setup script.

### Data Models

**Collections Schema [Source: /home/warrick/Dev/raceday/scripts/appwrite-setup.ts#22-31]:**
- Meetings collection: `meetings`
- Races collection: `races` 
- Entrants collection: `entrants`
- OddsHistory collection: `odds-history`
- MoneyFlowHistory collection: `money-flow-history`
- UserAlertConfigs collection: `user-alert-configs`
- Notifications collection: `notifications`

**NZTAB API Data Mapping [Source: docs/nztab/1-Initial-Data-review-reccomendations.txt#15-57]:**

**Meetings Collection Fields:**
- `meetingId` (String, required) ← `meeting` from API
- `meetingName` (String, required) ← `name` from API
- `country` (String, required) ← `country` from API
- `raceType` (String, required) ← `category_name` from API ('Thoroughbred Horse Racing', 'Harness') - Greyhounds excluded
- `date` (DateTime, required) ← `date` from API
- `status` (String, required) ← derived from race status or set to 'active'

**Races Collection Fields:**
- `raceId` (String, required) ← `id` from races array
- `name` (String, required) ← `name` from races array
- `raceNumber` (Integer, required) ← `race_number` from races array
- `startTime` (DateTime, required) ← `start_time` from races array
- `distance` (Integer, optional) ← `distance` from races array
- `trackCondition` (String, optional) ← `track_condition` from races array
- `weather` (String, optional) ← `weather` from races array
- `status` (String, required) ← `status` from races array
- `meeting` (Relationship to Meetings) ← linked by meeting ID

### API Specifications

**NZTAB API Endpoints [Source: docs/nztab/nztab-endpoints/NZTAB-API-ENDPOINTS.txt#1-7]:**
- Base URL: `https://api.tab.co.nz`
- Meetings endpoint: `{{baseUrl}}/affiliates/v1/racing/meetings`
- Race list endpoint: `{{baseUrl}}/affiliates/v1/racing/list?date_from=today`

**API Response Structure [Source: docs/nztab/nztab-endpoints/List-of-meetings.txt#19-50]:**
```json
{
  "header": { "title": "Race Meetings", "generated_time": "...", "url": "..." },
  "params": { "date_from": "...", "date_to": "...", "limit": 100, ... },
  "data": {
    "meetings": [
      {
        "meeting": "uuid",
        "name": "Meeting Name",
        "date": "2025-07-17T00:00:00Z",
        "track_condition": "",
        "category": "T|H|G",
        "category_name": "Thoroughbred Horse Racing|Harness",
        "country": "NZL|AUS",
        "races": [
          {
            "id": "uuid",
            "race_number": 1,
            "name": "Race Name",
            "start_time": "2025-07-17T14:15:00Z",
            "distance": 2000,
            "track_condition": "",
            "weather": "",
            "status": "Final|Open|etc"
          }
        ]
      }
    ]
  }
}
```

**Authentication Requirements:**
Environment variables must be stored in Appwrite Function configuration:
- API credentials will be used for NZTAB affiliate API access
- Function must handle API rate limiting and error responses

### Component Specifications

**Appwrite Function Configuration [Source: docs/architecture/3-backend-services-appwrite-functions.md#3-14]:**
- Function name: `daily-race-importer`
- Runtime: Node.js (v22.17.0+)
- Schedule: CRON trigger for 6:00 AM NZ time (0 17 * * * UTC / 0 18 * * * UTC during DST)
- Environment variables: NZTAB API credentials
- Timeout: Sufficient for API calls and database operations

**Function Dependencies [Source: docs/architecture/6-tech-stack.md#14-15]:**
- Appwrite Node.js SDK (v17.0.0+)
- Node.js fetch API for NZTAB API calls
- Error logging and monitoring

### File Locations

**Project Structure [Source: docs/architecture/7-source-tree.md#35-36]:**
Based on current Next.js structure, but note that task requirements specify:
1. **FIRST**: Restructure project to move Next.js frontend to 'client' folder and Appwrite functions to 'server' folder
2. Update path references in docker-compose and other configuration files
3. **THEN**: Create the function implementation

**Expected Structure After Restructuring:**
```
/
├── client/                    # Next.js frontend (moved from src/)
├── server/                    # Appwrite functions
│   ├── daily-race-importer/   # This function
│   │   ├── src/
│   │   │   └── main.js        # Function entry point
│   │   └── appwrite.json      # Function configuration
├── scripts/                   # Database setup scripts (unchanged)
├── docker-compose.yml         # Updated paths
└── other project files
```

### Testing Requirements

**Function Testing [Source: docs/architecture/8-coding-standards.md#23-25]:**
- All functions must include robust error handling and logging
- Environment variables must be validated
- Functions should be idempotent where possible
- Test API connectivity and response parsing
- Test database operations and relationship creation

### Technical Constraints

**Backend Standards [Source: docs/architecture/8-coding-standards.md#21-26]:**
- TypeScript required for all code
- Error handling and logging mandatory for all functions
- Environment variables for secrets/configuration (never hardcoded)
- Idempotent operations where possible
- All secrets stored as Appwrite Function environment variables

**Database Operations:**
- Use existing database ID: `raceday-db` [Source: /home/warrick/Dev/raceday/scripts/appwrite-setup.ts#21]
- Use existing collection IDs from config [Source: /home/warrick/Dev/raceday/scripts/appwrite-setup.ts#22-30]
- Handle duplicate entries gracefully (upsert operations)
- Maintain referential integrity between meetings and races

### Project Structure Notes

**Critical Restructuring Required:**
The current project has a standard Next.js structure with all code in `src/`. The task requirements explicitly state that project restructuring should be the FIRST task:

1. Move Next.js frontend to 'client' folder
2. Create 'server' folder for Appwrite functions  
3. Update docker-compose.yml path references
4. Both folders should be in project root alongside other files (.git, .gitignore, docs, etc.)

This restructuring must be completed before implementing the daily-race-importer function.

## Tasks / Subtasks

### Task 1: Project Restructuring (AC: Foundation)
1.1. Create 'client' and 'server' directories in project root
1.2. Move current 'src/' directory contents to 'client/src/'
1.3. Move package.json, next.config.ts, tailwind config, etc. to 'client/'
1.4. Update docker-compose.yml to reference './client' instead of current paths
1.5. Update any other path references in configuration files
1.6. Test that Next.js application still runs correctly from 'client' directory

### Task 2: Create Daily Race Importer Function Structure (AC: 1, 2, 3)
2.1. Create 'server/daily-race-importer' directory structure
2.2. Create appwrite.json function configuration with CRON schedule (6:00 AM NZ time - 0 17 * * * UTC / 0 18 * * * UTC during DST)
2.3. Create src/main.js entry point with basic function scaffold
2.4. Set up TypeScript configuration for the function
2.5. Configure environment variables template for NZTAB API credentials

### Task 3: Implement NZTAB API Integration (AC: 2, 3, 4)
3.1. Implement fetch logic for meetings endpoint (/affiliates/v1/racing/meetings)
3.2. Add date parameter to fetch current day's meetings
3.3. Add API filtering for Australia and New Zealand countries (country=AUS,NZL)
3.4. Add API filtering for Horse and Harness racing only (exclude Greyhounds)
3.5. Parse API response and extract meetings and races data  
3.6. Add error handling for API failures, timeouts, and invalid responses
3.7. Add logging for API call success/failure and data counts

### Task 4: Implement Database Operations (AC: 2, 4)
4.1. Initialize Appwrite client with database and collections access
4.2. Implement meeting upsert logic (create or update existing meetings) with AU/NZ Horse/Harness filtering
4.3. Implement race upsert logic with proper meeting relationship linking
4.4. Add validation for required fields before database operations
4.5. Add secondary filtering to ensure only Horse/Harness races are stored
4.6. Handle database errors and relationship constraints gracefully

### Task 5: Add Comprehensive Error Handling and Logging (AC: 3)
5.1. Implement structured logging with appropriate log levels
5.2. Add error handling for network failures, API rate limits, and timeouts
5.3. Add validation for environment variables and configuration
5.4. Log import statistics (meetings processed, races processed, errors)
5.5. Ensure function is idempotent for safe re-runs

### Task 6: Testing and Validation (Testing Requirements)
6.1. Create unit tests for API response parsing logic
6.2. Create integration tests for database operations
6.3. Test function with sample NZTAB API responses
6.4. Test error handling scenarios (API down, invalid data, database errors)
6.5. Validate CRON scheduling configuration

### Task 7: Documentation and Deployment Preparation (AC: 3)
7.1. Document function configuration and environment variables required
7.2. Create deployment guide for Appwrite Cloud
7.3. Document error monitoring and troubleshooting procedures
7.4. Update project README with new structure and function information

**Note:** All tasks must reference the architecture requirements and use the established database schema from the appwrite-setup.ts script. Idempotent operations are required to handle multiple runs safely.