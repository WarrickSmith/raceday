# Story 5.3: Apply Visual Alerts to Enhanced Entrants Grid

**Status**: Ready for Deployment

## Story

**As a** user,
**I want** to see visual background color indicators on cells in the Enhanced Entrants Grid,
**so that** I can quickly identify significant changes in money flow and odds movements.

## Acceptance Criteria

1. **Background Colors Display:**

   - [x] Background colors appear on cells when percentage thresholds are exceeded
   - [x] Colors match the configured indicator colors from user's alert configuration
   - [x] Only enabled indicators from configuration are displayed

2. **Real-Time Updates:**

   - [x] Visual indicators update in real-time as new race data arrives
   - [x] Indicators correctly switch between money and odds logic based on view selector
   - [x] No indicators shown for scratched horses

3. **Integration and Performance:**
   - [x] Alert calculation engine integrates seamlessly with Enhanced Entrants Grid component
   - [x] Visual updates maintain grid performance standards (<100ms update time)
   - [x] Indicators respect Win/Place/Odds selector button state for which logic to apply

## Tasks / Subtasks

- [x] **Integrate Alert Calculation Engine with Grid Component** (AC: 1, 3)

  - [x] Import alert calculation service and user configuration service into EnhancedEntrantsGrid.tsx
  - [x] Create hook to calculate indicators for all visible entrants based on current pool view state
  - [x] Add indicator calculation to grid re-render cycle when money flow data updates
  - [x] Handle performance optimization with React.useMemo for calculations

- [x] **Implement Cell Background Color Logic** (AC: 1, 2)

  - [x] Create utility function to map indicator results to Tailwind CSS background classes
  - [x] Apply background colors to Win Money, Place Money, and Win Odds column cells
  - [x] Implement 6-tier color system (Gray, Blue, Yellow, Green, Red, Magenta) matching Story 5.1 configuration
  - [x] Handle color transitions smoothly without jarring visual changes

- [x] **Add Pool View Toggle Integration** (AC: 2, 3)

  - [x] Connect indicators to existing PoolViewState (win/place/odds) from enhanced grid context
  - [x] Switch between money percentage logic and odds shortening logic based on view selector
  - [x] Only show money indicators in Win/Place views, odds indicators in Odds view
  - [x] Clear indicators when switching between different pool views

- [x] **Handle Real-Time Data Integration** (AC: 2)

  - [x] Subscribe to money flow timeline updates from useMoneyFlowTimeline hook
  - [x] Recalculate indicators when new money flow data arrives via real-time subscriptions
  - [x] Maintain indicator state during data refreshes to prevent flickering
  - [x] Handle edge cases where data is temporarily unavailable during updates

- [x] **Implement Scratched Horse Logic** (AC: 2)

  - [x] Skip indicator calculations for entrants marked as isScratched
  - [x] Ensure cells for scratched horses show no background colors
  - [x] Maintain consistent cell styling for scratched vs active entrants
  - [x] Test indicator behavior when horses get scratched during live race

- [x] **Create Comprehensive Test Suite** (AC: 1, 2, 3)
  - [x] Test indicator calculation integration with mock money flow data
  - [x] Test color application logic with various percentage thresholds
  - [x] Test real-time updates and performance under high-frequency data changes
  - [x] Test pool view switching and indicator logic transitions
  - [x] Test scratched horse handling and edge cases

## Dev Notes

### Previous Story Insights

From Story 5.2: Alert calculation engine is complete with `alertCalculationService.ts`, supporting money percentage calculations (timeframe-specific totals) and win odds shortening detection. The 6-tier threshold system (5-10% → Gray through 50%+ → Magenta) is implemented with proper mathematical accuracy. Integration with Story 5.1's `alertConfigService.ts` for user preferences is established. All functions are optimized for <100ms execution suitable for real-time updates.

From Story 5.1: Alert configuration infrastructure includes `AlertsConfigModal.tsx` and `alertConfigService.ts` with user preference storage in `user-alert-configs` collection. Users can enable/disable specific indicator thresholds through the configuration interface.

### Data Models

**Money Flow History Integration:**
[Source: architecture/4-database-schema-appwrite.md#money-flow-history]

- Use existing `money-flow-history` collection with fields: `entrant`, `raceId`, `holdPercentage`, `betPercentage`, `timeToStart`, `timeInterval`, `eventTimestamp`, `winPoolAmount`, `placePoolAmount`, `incrementalAmount`
- Data accessed via `useMoneyFlowTimeline` hook which provides real-time updates
- Money flow data structured in timeframe buckets for percentage calculations

**User Alert Configuration:**
[Source: architecture/4-database-schema-appwrite.md#user-alert-configs]

- Integration with existing `user-alert-configs` collection: `userId`, `alertType`, `threshold`, `enabled`
- User preferences loaded via `alertConfigService.ts` from Story 5.1
- Only display indicators for thresholds marked as enabled by user

**Enhanced Grid Context:**
[Source: client/src/components/race-view/EnhancedEntrantsGrid.tsx]

- Grid uses `PoolViewState` for Win/Place/Odds view switching
- Real-time data updates through `useMoneyFlowTimeline` and `useRace` context
- Grid optimized with performance tracking via `useRenderTracking` and `useMemoryOptimization`

### Component Specifications

**Enhanced Entrants Grid Architecture:**
[Source: architecture/3-frontend-architecture-nextjs-15.md#enhanced-component-architecture]

- Grid component located at `src/components/race-view/EnhancedEntrantsGrid.tsx`
- Uses React memo patterns with `WinOddsCell` and `PlaceOddsCell` components
- Flash-enabled cells with `useValueFlash` hook for visual feedback
- Sticky column positioning with z-index layering for proper display

**Grid Cell Structure:**
[Source: client/src/components/race-view/EnhancedEntrantsGrid.tsx:23-76]

- Cells use Tailwind CSS classes for styling: `px-2 py-1 whitespace-nowrap text-right border-r`
- Background colors applied via `backgroundColor` style or CSS classes
- Height standardized at 30px for consistent grid appearance
- Scratched entrants show "—" instead of values

**Real-Time Integration Pattern:**
[Source: architecture/3-frontend-architecture-nextjs-15.md#enhanced-race-interface-implementation]

- Use `useMoneyFlowTimeline` hook for money flow data subscription
- Real-time updates trigger grid re-render with new indicator calculations
- Performance optimized with `React.useMemo()` and `useCallback()` patterns

### File Locations

**Primary Integration Files:**
[Source: architecture/7-source-tree.md]

- **Main Component:** `src/components/race-view/EnhancedEntrantsGrid.tsx` (existing, to be modified)
- **Alert Services:** `src/services/alertCalculationService.ts` (existing from Story 5.2)
- **User Config:** `src/services/alertConfigService.ts` (existing from Story 5.1)

**New Utility Files:**

- **Color Mapping:** `src/utils/indicatorColors.ts` - Map indicator results to CSS classes
- **Grid Indicators:** `src/hooks/useGridIndicators.ts` - Custom hook for grid indicator logic

**Test Files:**

- **Integration Tests:** `src/components/race-view/__tests__/EnhancedEntrantsGrid.test.tsx`
- **Hook Tests:** `src/hooks/__tests__/useGridIndicators.test.ts`
- **Color Tests:** `src/utils/__tests__/indicatorColors.test.ts`

### Testing Requirements

**Test Framework:**
[Source: CLAUDE.md#testing-strategy]

Based on existing project patterns, use Jest and React Testing Library. Follow existing test patterns in component `__tests__` directories.

**Integration Testing Scenarios:**

**Grid Indicator Integration:**

- Test alert calculation service integration with grid component
- Verify indicators appear only for enabled user thresholds
- Test performance with multiple entrants and real-time data updates
- Validate color mapping accuracy for all 6 indicator ranges

**Real-Time Update Testing:**

- Mock `useMoneyFlowTimeline` hook responses for controlled testing
- Test indicator recalculation when new money flow data arrives
- Verify smooth visual transitions during data updates
- Test pool view switching (Win → Place → Odds) indicator logic

**Edge Case Testing:**

- Test scratched horse handling (no indicators displayed)
- Test missing money flow data graceful degradation
- Test user configuration changes affecting displayed indicators
- Test performance under high-frequency real-time updates

**Visual Regression Testing:**

- Test color application doesn't break existing cell styling
- Verify sticky column positioning remains intact with background colors
- Test grid layout consistency with and without indicators
- Validate accessibility with colored backgrounds

### Technical Constraints

**Performance Requirements:**
[Source: architecture/6-tech-stack.md#performance-targets]

- Indicator calculations must execute within <100ms for real-time grid updates
- Use React.memo and useMemo patterns to prevent unnecessary re-renders
- Batch indicator calculations for all visible entrants efficiently
- Maintain Core Web Vitals compliance with visual updates

**Styling Requirements:**
[Source: architecture/6-tech-stack.md#ui-and-styling]

- Use Tailwind CSS 4.0+ utility classes for background colors
- Maintain responsive design with container queries
- Ensure WCAG 2.1 compliance with proper color contrast ratios
- Support both light and potential dark theme variations

**Real-Time Data Constraints:**

- Handle temporary data unavailability during real-time subscription reconnection
- Prevent indicator flickering during rapid data updates
- Maintain calculation accuracy with high-frequency money flow changes
- Support graceful degradation when alert services are unavailable

### Project Structure Notes

No structural conflicts identified. Alert integration builds on existing Story 5.1 and 5.2 infrastructure. Enhanced Entrants Grid component already has performance optimizations and real-time data integration patterns established. New utility files align with existing `src/utils/` and `src/hooks/` directory structure.

## Change Log

| Date       | Version | Description                                               | Author             |
| ---------- | ------- | --------------------------------------------------------- | ------------------ |
| 2025-09-17 | 1.0     | Initial story creation for Visual Alerts Grid Integration | Bob (Scrum Master) |

## Dev Agent Record

**Agent Model Used**: GPT-5 (Codex CLI)

### Tasks / Subtasks Status

- All story tasks and subtasks checked above were implemented in this iteration, including the new indicator hook, color mapping utility, pool view integration, and comprehensive testing.

### Debug Log References

- `npm test -- --runInBand --runTestsByPath src/hooks/__tests__/useGridIndicators.test.ts src/components/race-view/__tests__/EnhancedEntrantsGridIndicators.test.tsx`
- `npm test -- --runInBand --runTestsByPath src/utils/__tests__/indicatorColors.test.ts src/services/__tests__/alertCalculationService.test.ts src/components/race-view/__tests__/EnhancedEntrantsGridIndicators.test.tsx src/components/alerts/__tests__/AlertsConfigModal.test.tsx`

### Completion Notes

- Added `useGridIndicators` hook to batch money and odds indicator calculations against user alert preferences while avoiding redundant renders with memoization.
- Applied indicator backgrounds to timeline cells via `mapIndicatorColorToCellStyle`, respecting configured colors, view mode, and scratched entrants.
- Ensured indicators recompute for initial money-flow fetch and subsequent timeline updates without introducing extra grid renders.
- Covered logic with targeted unit tests for the hook and utility plus a grid integration test that exercises the new styling path.
- Refreshed default indicator colors and palette to soft pastels and locked grid indicator text to black for improved readability across the subtler theme.

### File List

**Created**

- `client/src/hooks/useGridIndicators.ts`
- `client/src/utils/indicatorColors.ts`
- `client/src/hooks/__tests__/useGridIndicators.test.ts`
- `client/src/utils/__tests__/indicatorColors.test.ts`
- `client/src/components/race-view/__tests__/EnhancedEntrantsGridIndicators.test.tsx`

**Modified**

- `client/src/components/race-view/EnhancedEntrantsGrid.tsx`

### Change Log (Dev Agent)

| Date       | Version | Description                                                            | Author |
| ---------- | ------- | ---------------------------------------------------------------------- | ------ |
| 2025-09-18 | 1.1     | Integrated timeline indicator styling, created supporting hook & tests | James  |
| 2025-09-18 | 1.2     | Softened default indicator palette and enforced black grid text        | James  |

## QA Results

### Review Date: 2025-09-18

### Reviewed By: Quinn (Test Architect)

### Assessment Summary

Implementation meets all acceptance criteria. Pastel defaults propagate through alert configuration, calculation outputs, and grid rendering with consistent black typography. Indicator logic remains responsive to money/odds updates while respecting disabled thresholds. No regressions detected in related services or UI flows.

### Testing & Evidence

- `npm test -- --runInBand --runTestsByPath src/hooks/__tests__/useGridIndicators.test.ts src/utils/__tests__/indicatorColors.test.ts src/services/__tests__/alertCalculationService.test.ts src/components/alerts/__tests__/AlertsConfigModal.test.tsx src/components/race-view/__tests__/EnhancedEntrantsGridIndicators.test.tsx`

### Findings

- PASS – Soft pastel colors reflected across defaults and palette while grid text stays black for readability (`client/src/types/alerts.ts`, `client/src/utils/indicatorColors.ts`).
- PASS – Indicator computation still respects thresholds/config toggles after palette change (`client/src/hooks/useGridIndicators.ts`, `client/src/services/__tests__/alertCalculationService.test.ts`).
- PASS – Timeline cells apply new styling without layout artefacts and tests cover the rendered state (`client/src/components/race-view/EnhancedEntrantsGrid.tsx`, `client/src/components/race-view/__tests__/EnhancedEntrantsGridIndicators.test.tsx`).

### Risks / Follow-ups

- Console warnings from legacy tests about missing `act(...)` wrappers remain unchanged; treat as known noise for now.

### Gate Status

Gate: PASS → docs/qa/gates/5.3-apply-visual-alerts-to-enhanced-entrants-grid.yml
