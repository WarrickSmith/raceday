# Story 5.4: Implement Global Audible Alert Toggle

**Status**: Draft

## Story

**As a** user  
**I want** to enable/disable a global, audible alert that triggers one minute before the start of any scheduled race starttime, irrespective of where I am in the application, meetings or race pages.  
**so that** I am aware of upcoming races.

## Acceptance Criteria

1. **Audible Alert Trigger:**

   - [ ] Audible alert triggers one minute before each filtered race start time
   - [ ] Alert uses the designated race start sound asset
   - [ ] Alert does not fire once the race has started or been marked Final

2. **Global Toggle Control:**

   - [ ] User can enable or disable the audible alert via the global toggle UI
   - [ ] Toggle state persists per user session
   - [ ] Toggle state reflects the stored user preference on load

3. **Filter Awareness:**

   - [ ] Only races matching the userâ€™s current filters trigger audible alerts
   - [ ] Toggle and alerts behave consistently across dashboard and race detail views
   - [ ] Audio playback avoids overlaps when multiple races qualify simultaneously

## Tasks / Subtasks

- [ ] **Implement Global Audible Toggle UI** (AC: 2)  
  - [ ] Replace the placeholder toggle in the Enhanced Entrants header with an accessible, global audio toggle component  
  - [ ] Apply Tailwind styling that aligns with the alerts interface and adheres to accessible focus states  
  - [ ] Reflect the persisted toggle state when the race view renders  
  `[Source: architecture/3-frontend-architecture-nextjs-15.md#32-enhanced-component-architecture-v47]`  
  `[Source: architecture/6-tech-stack.md#614-ui-and-styling]`

- [ ] **Persist Audible Alert Preference** (AC: 2)  
  - [ ] Extend existing alert configuration persistence to store the global audio toggle preference  
  - [ ] Ensure user-specific storage continues to leverage Appwrite session-based access control  
  - [ ] Update types/services to expose helper functions for reading and writing the audio preference  
  `[Source: architecture/4-database-schema-appwrite.md#41-core-collections]`  
  `[Source: architecture/6-tech-stack.md#622-appwrite-sdk-strategy]`  
  `[Source: architecture/6-tech-stack.md#615-state-management]`

- [ ] **Schedule and Trigger Audio Alerts** (AC: 1, 3)  
  - [ ] Create a client hook that monitors upcoming race start times (T-1m) using existing real-time race data  
  - [ ] Gate audio playback by the global toggle state and current dashboard/race filters  
  - [ ] Prevent duplicate or overlapping playback by debouncing trigger events per raceId  
  `[Source: architecture/12-client-integration.md#121-enhanced-real-time-data-architecture]`  
  `[Source: architecture/2-microservices-backend-architecture.md#22-real-time-functions]`  
  `[Source: architecture/4-database-schema-appwrite.md#41-core-collections]`

- [ ] **Manage Race Start Audio Asset** (AC: 1)  
  - [ ] Relocate `race_start.mp3` into the Next.js public assets directory for client access  
  - [ ] Preload or prime the audio element to avoid playback delay when triggered  
  - [ ] Document asset usage within the alerts configuration codebase for future updates  
  `[Source: architecture/7-source-tree.md#7-source-tree]`

- [ ] **Testing & Validation** (AC: 1, 2, 3)  
  - [ ] Add unit tests for the hook/service logic covering toggle states, filter awareness, and race scheduling  
  - [ ] Write integration tests that simulate upcoming races and verify audio trigger gating  
  - [ ] Create manual QA checklist entries for cross-view toggle consistency and audible playback  
  `[Source: docs/testing/manual-testing-strategy.md#overview]`  
  `[Source: architecture/6-tech-stack.md#64-performance-targets]`

## Dev Notes

### Previous Story Insights

- Story 5.3 established real-time indicator updates inside `EnhancedEntrantsGrid`, confirming existing hooks for timeline data and view context that the audible toggle must respect.
- Story 5.2 delivered the alert calculation service with user preference integration, providing a persistence pattern for alert-related settings that this story should extend.

### Data Models

- **Races collection** stores `startTime`, `status`, and meeting linkage needed to determine when to fire alerts. `[Source: architecture/4-database-schema-appwrite.md#41-core-collections]`
- **User alert configurations** already live in `user-alert-configs` for storing user-specific alert preferences, offering a natural extension point for the audio toggle. `[Source: architecture/4-database-schema-appwrite.md#41-core-collections]`

### API Specifications

- Client interactions with Appwrite use the web SDK within client components, relying on session-based authentication to protect user preferences. `[Source: architecture/6-tech-stack.md#622-appwrite-sdk-strategy]`
- Real-time alert timing should leverage the existing Appwrite subscriptions that stream entrant and race updates for sub-second latency. `[Source: architecture/12-client-integration.md#121-enhanced-real-time-data-architecture]`

### Component Specifications

- `EnhancedEntrantsGrid` and related race-view components reside under `src/components/race-view/`, providing the context for the global toggle UI. `[Source: architecture/3-frontend-architecture-nextjs-15.md#32-enhanced-component-architecture-v47]`
- Hooks for race data and timeline management (e.g., `useMoneyFlowTimeline`, `useUnifiedRaceSubscription`) live in `src/hooks/` and should be reused for scheduling logic. `[Source: architecture/12-client-integration.md#122-money-flow-timeline-integration]`

### File Locations

- Place shared hooks in `src/hooks/` and services in `src/services/` per the source tree structure. `[Source: architecture/7-source-tree.md#7-source-tree]`
- Static assets such as audio files belong in the `public/` directory for Next.js to serve. `[Source: architecture/7-source-tree.md#7-source-tree]`

### Testing Requirements

- Follow the manual testing strategy to validate user-facing audio behavior, cross-view consistency, and performance expectations. `[Source: docs/testing/manual-testing-strategy.md#overview]`
- Maintain performance targets for real-time responsiveness (<2s) when triggering alerts. `[Source: architecture/6-tech-stack.md#642-application-metrics]`

### Technical Constraints

- Ensure client components stay performant by memoizing heavy computations and throttling real-time updates, in line with real-time performance guidance. `[Source: architecture/5-key-architectural-improvements.md#53-real-time-performance]`
- Keep audio trigger logic within established Next.js 15 client component patterns and TypeScript usage. `[Source: architecture/6-tech-stack.md#611-core-framework]`

## Change Log

| Date       | Version | Description                                   | Author |
| ---------- | ------- | --------------------------------------------- | ------ |
| 2025-09-19 | 1.0     | Initial draft for global audible alert toggle | Bob (Scrum Master) |

## Dev Agent Record

**Agent Model Used**: _(to be completed by Dev Agent)_

### Tasks / Subtasks Status

_(to be completed by Dev Agent)_

### Debug Log References

_(to be completed by Dev Agent)_

### Completion Notes

_(to be completed by Dev Agent)_

### File List

_(to be completed by Dev Agent)_

### Change Log (Dev Agent)

_(to be completed by Dev Agent)_

## QA Results

_(to be completed by QA Agent)_
